二、策略道具全分析

1、攻击性策略与道具
http://www.xycq.net/forum/thread-213692-1-1.html
原作者：ctermiii

2、查看类策略与道具

如果是策略，则要计算成功率：

计算一个0~(攻击方智力-1)的随机数，如果
随机数大于等于防御方智力/4，那么策略成功。
但是如果防御方具有减轻策略损伤的状态，那么要再算一次随机数，两次都大于等于防御方智力/4，策略才能成功。

查看策略：A=8，B=5
侦察策略：A=15，B=11
谍报策略：A=30，B=11
查看书：A=5，B=4
侦察书：A=11，B=6
谍报书：A=20，B=11

计算一个0~(B-1)的随机数，查看类的损伤就是
A+随机数。

如果防御方具有减轻策略损伤的状态，那么计算结果要除以2。

最后，损伤不能超过防御方剩余策略值。

3、压迫类、骂声类的策略与道具

如果是策略，则要计算成功率：

计算一个0~(攻击方智力-1)的随机数，如果
随机数大于等于防御方智力/3，那么策略成功。
但是如果防御方具有减轻策略损伤的状态，那么要再算一次随机数，两次都大于等于防御方智力/3，策略才能成功。

最后的效果：
a、双降，能力变为原来的2/3
b、单降，能力变为原来的4/5
c、单升，能力变为原来的6/5
d、双升，能力变为原来的3/2

4、假情报类策略与道具

如果是策略，则要计算成功率：

计算一个0~(攻击方智力-1)的随机数，如果
随机数大于等于防御方智力/3，那么策略成功。
但是如果防御方具有减轻策略损伤的状态，那么要再算一次随机数，两次都大于等于防御方智力/3，策略才能成功。

如果成功，则混乱。

5、反间类策略与道具

如果是策略，则要计算成功率：

计算一个0~(攻击方智力-1)的随机数，如果
随机数大于等于防御方智力/3，那么策略成功。
但是如果防御方具有减轻策略损伤的状态，那么要再算一次随机数，两次都大于等于防御方智力/3，策略才能成功。

如果成功，每回合耐久力减少10%，直到撤退或状态恢复。

6、牵制、止步策略与道具

如果是策略，则要计算成功率：

计算一个0~(攻击方智力-1)的随机数，如果
随机数大于等于防御方智力/5，那么策略成功。
但是如果防御方具有减轻策略损伤的状态，那么要再算一次随机数，两次都大于等于防御方智力/5，策略才能成功。

如果成功，攻击速度（牵制）或移动速度（止步）减半。

7、补给类策略与道具

恢复豆、援队书：使用者智力/10+100
恢复麦、援部书：使用者智力/5+300
恢复米、援军书：2*使用者智力/5+500
恢复肉、援国书：补满
小补给、援队：使用者智力/2+20
中补给、援部：4*使用者智力/5+40
大补给、援军：11*使用者智力/10+60
全补给、援国：补满

恢复后的剩余耐久力不能超过最大耐久力。

8、策略恢复类策略与道具

进言、药：　　恢复20策略值
献策、中药：　恢复40策略值
施策、华佗药：恢复80策略值

不能给物资队恢复策略。

9、状态恢复类策略与道具

苏醒书、觉醒：混乱状态恢复
恢复书、康复：耐久力每回合减少状态恢复
释放书、解放：攻击速度减半状态恢复
轻功书、轻功：移动速度减半状态恢复

10、奋起类、坚固类策略与道具

暂时提高攻击力、防御力，最后的效果同3

11、对策、回归、升格策略与道具

对策：减轻策略损伤
回归：恢复回合结束的状态
升格：兵种提升

升格的道具有：长兵器指南书、近卫兵心得 等等。

12、封策策略与道具

如果是策略，则要计算成功率：

计算一个0~(攻击方智力-1)的随机数，如果
随机数大于等于防御方智力/3，那么策略成功。
但是如果防御方具有减轻策略损伤的状态，那么要再算一次随机数，两次都大于等于防御方智力/3，策略才能成功。

如果成功，则不能使用策略。

13、能力提升类道具

武勇种、智谋种、仁爱种、精神种
分别增加
武力、智力、统率力、策略值上限
0~3的随机数+2

武勇果、智谋果、仁爱果、精神果
分别增加
武力、智力、统率力、策略值上限
0~5的随机数+5

对应能力不能超过255。

根性种增加耐久力上限
0~10的随机数+15

根性果增加耐久力上限
0~20的随机数+30

耐久力上限最大1000。

14、经验种、经验果

http://www.xycq.net/forum/thread-213663-1-1.html

的8楼，原作者godtype

15、武器、防具、车马、兵书

略

三、经验获得全分析

http://www.xycq.net/forum/thread-213663-1-1.html
原作者：godtype

四、自动恢复全分析

1、处在恢复地形或者持有兵书的部队，每回合可以自动恢复部分耐久力。且两个条件都满足的话，恢复可以叠加。

恢复量为：

(0~4的随机数+地形恢复效果)*最大耐久力/100+兵书恢复效果*最大耐久力/100

地形恢复效果：
兵营5
村庄10
鹿砦15
关隘20
城池25

兵书恢复效果（若一支部队携带多本兵书，则只计算效果最高的一本）：
三略10
六韬15
孟德新书20
孙子兵法25

恢复后的耐久力不能超过最大耐久力。

2、处在军乐队周围的部队每回合可以恢复策略值
恢复量=军乐队的智力/10+1

物资队的策略值不能恢复；
我军的军乐队不能给敌军恢复策略值，反之亦然。

3、每回合自动恢复状态

a、如果是好的状态（攻防上升、策略损伤减轻）

恢复某一个状态（去掉策略损伤减轻，去掉一阶攻防上升，二阶攻防上升降为一阶）要求

计算一个0~[(智力+防御力)/100+20-1]的随机数，如果小于等于A，则恢复该状态。

其中A的取值与兵种类型有关：
军师系、运粮队、物资队、军乐队、皇帝、都督、幻术师：1
步兵系、弓兵系、战车系、炮车系：2
骑兵系、弓骑兵系、贼兵系、武术家系：3
少数民族兵种、动物兵团：4

b、如果是坏的状态（攻防下降、混乱、耐久力每回合减少等）

恢复某一个状态（去掉不良状态，去掉一阶攻防下降，二阶攻防下降降为一阶）要求

计算一个0~[20-(智力+防御力)/100-1]的随机数，如果小于等于B，则恢复该状态。

其中B的取值与兵种类型有关：
军师系：10
运粮队、物资队、军乐队、皇帝、都督、幻术师：4
步兵系、弓兵系、战车系、炮车系：3
骑兵系、弓骑兵系、贼兵系、武术家系：2
少数民族兵种、动物兵团：1

注意：
1、一次计算只能恢复一种状态。如果是N个状态则要计算N次。

2、由于每个部队有3个状态变量，分别是：攻击力升降、防御力升降、其他状态。
在每次附上状态后，所属状态的变量第6位（最右边为第0位，最左边为第7位）被置位。
于是判断是否恢复之前，要先判断该位是否为1。若为1则该位清零，跳过判断过程。若为0，才能进行判断。
也就是说，附上状态后，至少要隔一个回合才能恢复（无论要恢复的与附上的是否是同一种状态）。

五、天气算法

天气代码：00、01、02晴，03云，04、05雨

A=0~5的随机数
B=存储天气的变量

如果A>B，则B加1；如果A<B，则B减1。

如果B=5，则B=0；如果B=0，则B=5。

注：孔明传的天气算法与英杰传完全一致。

六、武将基本数据及战场数据的内存

从0x4556E8开始，每个武将基本数据占54个字节

+00 2字节 武将代码
+02 4字节 未知
+06 7字节 武将姓名（虽然一个汉字是2个字节，但是字符串要以0x00结尾）
+0D 1字节 未知
+0E 2字节 未知
+10 4字节 未知
+14 2字节 未知
+16 2字节 头像编号
+18 2字节 未知
+1A 1字节 所属君主
+1B 1字节 武力
+1C 1字节 统率力
+1D 1字节 智力
+1E 2字节 最大耐久力
+20 2字节 未知
+22 1字节 最大策略值
+23 1字节 未知
+24 1字节 兵种
+25 1字节 等级
+26 1字节 经验值
+27 15字节 15个道具


从0x46C098开始，每个武将战场附加数据占23个字节

+00 2字节 人物代码
+02 2字节 未知，但是改成其他值会出错退出
+04 1字节 战场编号
+05 1字节 战场横坐标（左起为0，FF表示伏兵）
+06 1字节 战场纵坐标（上起为0，FF表示伏兵）
+07 1字节 仇人战场编号，FF表示没有仇人
+08 1字节 目标X坐标
+09 1字节 目标Y坐标
+0A 1字节 行动顺序编号，00为最先行动的。
+0B 1字节 00=未出场，01=伏兵，02=正常，03=撤退
+0C 1字节 二进制，10=朝向（该位为1则朝右），20=全屏移动，40=形象不动（在移动动作显示结束时写入），80=回合结束
+0D 1字节 AI，若AI≠07则为友军或敌军
+0E 1字节 在移动过程中（即显示移动动作时）的方向，00=上，01=右，02=下，03=左
+0F 4字节 剩余耐久力（实际只有2字节）
+13 1字节 剩余策略值
+14 1字节 攻击力升降属性：00=双升，01=单升，02=正常，03=单降，04=双降
+15 1字节 防御力升降属性：同上
+16 1字节 状态（二进制）：01=移动力下降，02=攻击速度下降，04=封策，08=对策，10=混乱，20=耐久力每回合减少，40=刚附上状态，下一回合消失。

七、AI类型


00=(X,Y) 移动/n 移动：
若移动范围+攻击范围内有我军就选择行动价值最高的动作，否则：
1、当仇人代码为n=FF时，朝着(X,Y)坐标移动。
2、当仇人代码为n=FF时，且到达了(X,Y)坐标，则AI变为03=(X,Y) 待命。
3、当仇人代码为n=00~2C且仇人还在场时，朝着战场n号人物移动。
4、若仇人代码为n=00~2C且仇人消失，则AI变为01=攻击最近敌。

01=攻击最近敌：
若移动范围+攻击范围内有我军就选择行动价值最高的动作，否则向最近的我军移动。

02=(X,Y) 不动/n 不动：
无论攻击范围内是否有我军都会选择行动价值最高的动作，但是不会移动。
X,Y,n都无意义。（不确定）

03=(X,Y) 待命/n 待命：
若移动范围+攻击范围内有我军就选择行动价值最高的动作，否则不会移动。
X,Y,n都无意义。（不确定）

04=(X,Y) 无攻击移动/n 无攻击移动：
只会朝着目标坐标(X,Y)移动（若仇人代码为FF）或战场n号人物移动，不会攻击或使用策略。
1、当仇人代码为n=FF时，且到达了(X,Y)坐标，则AI变为03=(X,Y) 待命。
2、若仇人代码为n=00~2C且仇人消失，则AI变为01=攻击最近敌。

07=键入
若我方AI≠07，则为友军。

八、行动价值概述

行动价值是一个反映一支电脑操控的部队行动准则的数字。
每个可能的走位及每个可能的动作都会计算其对应的行动价值。
电脑操控的部队会选择行动价值最高的动作。

基本规则：
1、物理攻击和策略的行动价值相等时，优先采用物理攻击。
2、若存在行动价值相等的多个策略，优先采用策略编号小的策略。
3、物理攻击或使用策略，若存在行动价值相等的多个目标时，按照下图优先级（序号小的优先考虑）：


图1：适用于普通、高级策略、弩兵、连弩兵、弩骑兵、连弩骑兵、炮车系（粉红色区域）



图2：适用于普通、中级策略、弓兵、弓骑兵

九、物理攻击行动价值

0、使用攻击伤害函数计算一次伤害。注意：
0.1、计算伤害时，计算攻击方地形加成使用的是攻击方当前坐标而不是攻击时的坐标。
0.2、之后与等级相关的随机数加成与连击相关的算法，不进行计算。

1、如果攻击致命（攻击伤害>=防御方剩余耐久力），则行动价值=75。如果防御方还是象或蛇兵团，则行动价值再加5。

2、如果攻击不能致命，那么：
2.1、如果攻击伤害<防御方最大耐久力*10%，那么：
2.1.1、如果防御方还有>=41%的耐久力，那么：
　　　　如果攻击方AI≠1，或者攻击方是三大后勤兵种，那么行动价值=0。否则行动价值=10。
2.1.2、如果防御方还有<41%的耐久力，那么：
　　　　行动价值=16

2.2、如果攻击伤害>=防御方最大耐久力*10%，那么：
　　行动价值=16。如果防御方还是象或蛇兵团，则行动价值再加4。

3、如果防御方混乱，行动价值再加8。

4、如果行动价值>0，且防御方是我军或敌军主将，那么行动价值加10。

5、如果行动价值>0，且防御方是我军或敌军其他的有名字的武将，那么行动价值加6。

6、如果上述计算的行动价值<75，且攻击方是军师系、后勤、幻术师，则行动价值=0。

7、如果攻击方是象兵团，则周围8格有n个可以攻击到的（包括攻击点本身），行动价值再加 10*n。

8、如果攻击方是蛇兵团，则周围4格有n个可以攻击到的（包括攻击点本身），行动价值再加 10*n。

9、物理攻击行动价值最低为1。
十、策略行动价值

（一）攻击性策略
1、如果受计方地形符合条件，且不是雨天（如果是火计），并且100-100*受计方智力/施计防智力/5>=50，那么：
　1.1、先用策略伤害函数计算一次对中心点伤害。
　1.2、如果致命（策略伤害>=受计方剩余耐久力），行动价值=80。
　1.3、如果不致命，行动价值=20。
　1.4、如果是大策略，那么中心点周围4格有n个人(n>=1)，行动价值再加10*n。
　1.5、如果是大策略，那么中心点周围4格没有人，行动价值减4。
2、如果不满足第1步需要的条件，那么行动价值=0。

（二）查看类
如果受计方剩余策略值>0，且100-100*受计方智力/施计防智力/4>=50，那么行动价值=17；否则行动价值=0。

（三）压迫、威压
1、如果受计方攻击力已经是双降了，行动价值=0。
2、如果受计方攻击力不是双降，那么
　如果 100-100*受计方智力/施计防智力/3>=50，则行动价值=18；否则行动价值=0。
3、如果是威压，那么以受计方坐标为中心点，周围4格有n个人(n>=1)，行动价值再加10*n。
4、如果是威压，那么中心点周围4格没有人，行动价值减4（最低为0）。

（三）骂声、挑拨
1、如果受计方防御力已经是双降了，行动价值=0。
2、如果受计方防御力不是双降，那么
　 如果 100-100*受计方智力/施计防智力/3>=50，则行动价值=19；否则行动价值=0。
3、如果是挑拨，那么以受计方坐标为中心点，周围4格有n个人(n>=1)，行动价值再加10*n。
4、如果是挑拨，那么中心点周围4格没有人，行动价值减4（最低为0）。

（四）假情报、伪兵
1、如果受计方剩余耐久力不足40%，行动价值=0。
2、如果受计方剩余耐久力>=40%，那么
　 如果 100-100*受计方智力/施计防智力/4>=50，则行动价值=22；否则行动价值=0。
3、如果是伪兵，那么以受计方坐标为中心点，周围4格有n个人(n>=1)，行动价值再加10*n。
4、如果是伪兵，那么中心点周围4格没有人，行动价值减4（最低为0）。
5、如果受计方已经混乱，行动价值=0。

（五）反间、流言
1、如果受计方剩余耐久力不足40%，行动价值=0。
2、如果受计方剩余耐久力>=40%，那么
　 如果 100-100*受计方智力/施计防智力/3>=50，则行动价值=20；否则行动价值=0。
3、如果是流言，那么以受计方坐标为中心点，周围4格有n个人(n>=1)，行动价值再加10*n。
4、如果是流言，那么中心点周围4格没有人，行动价值减4（最低为0）。
5、如果受计方已经有耐久力每回合减少的状态，行动价值=0。

（六）牵制
1、如果受计方兵种攻击速度>=8（武术家、大武术家、猛虎兵团），那么行动价值=23，否则行动价值=0。
2、如果受计方已经有攻击速度减半的状态，行动价值=0。

（七）止步
如果受计方没有移动速度减半的状态，行动价值=25，否则行动价值=0。

（八）封策
如果受计方是文官（军师系、后勤、幻术师）且没有策略被封的状态，行动价值=24，否则行动价值=0。

（九）耐久力恢复
1、计算策略威力基数：
  小补给、援队=0；
  中补给、援部=1；
  大补给、援军=2；
  全补给、援国=3。
2、如果受计方剩余耐久力<50%，那么：
　2.0、行动价值=30。
　2.1、如果不是全补给或援国，期望值=施计方等级+200*(威力基数+1)
　2.2、如果是全补给或援国，期望值=受计方最大耐久力。
　2.3、如果恢复了期望值之后满血，则
　　 期望值=受计方最大耐久力-剩余耐久力；
　　 行动价值加2。
　2.4、如果 (受计方最大耐久力-剩余耐久力)/期望值<=60%，则行动价值减4。（从逻辑上看，该步骤永远不可能被执行，因为条件根本无法满足。）
　2.5、如果受计方剩余耐久力<=20%，那么行动价值加4。
　2.6、如果对自己使用，行动价值加1。
3、如果受计方剩余耐久力>=50%，那么行动价值=0。
4.1、如果是大策略，那么自己周围8格有n个不满血的人(n>=1)，行动价值再加10*n。
4.2、如果是大策略，那么自己周围8格没有不满血的人，行动价值减4。

（十）策略值恢复
1、满足以下条件之一时，行动价值=0：
　1.1、受计方剩余策略值>=50%。
　1.2、受计方是物资队。
　1.3、受计方是施计方（例如皇帝会施策，但是却不能对自己使用）。
　1.4、受计方最大策略值=0（例如骑兵系、弓骑兵系、武术家系）。
2、上述条件皆不满足时：
　2.0、行动价值=28。
　2.1、计算恢复量，即：进言20，献策40，施策80。
　2.2、如果恢复了之后满策略值，则行动价值加2。
　2.3、如果 (受计方最大策略值-剩余策略值)/恢复量<=60%，则行动价值减4。
　2.4、如果受计方剩余策略值<=20%，那么行动价值加4。

（十一）觉醒
如果受计方混乱，行动价值=32，否则行动价值=0。

（十二）康复
如果受计方中了耐久力每回合减少状态，行动价值=31，否则行动价值=0。

（十三）解放
如果受计方中了攻击速度减半状态，行动价值=27，否则行动价值=0。

（十四）轻功
如果受计方中了移动速度减半状态，行动价值=26，否则行动价值=0。

（十五）奋起、鼓舞
1、如果受计方攻击力已经是双升了，行动价值=0。
2、如果受计方攻击力是单升或正常，那么
　 受计方不是文官，行动价值=12；否则行动价值=0。
3、如果受计方攻击力是单降，行动价值=29。
4、如果受计方攻击力是双降，行动价值=31。
5、如果是鼓舞，那么以受计方坐标为中心点，周围4格有n个攻击力不是双升的人(n>=1)，行动价值再加10*n。
6、如果是鼓舞，那么中心点周围4格没有攻击力不是双升的人，行动价值减4（最低为0）。
7、如果对自己使用，行动价值减1。
8、如果施计方的移动范围+攻击范围内没有敌人，那么行动价值=0。

（十六）坚固、强阵
1、如果受计方防御力已经是双升了，行动价值=0。
2、如果受计方防御力是单升或正常，那么
　 受计方不是文官，行动价值=11；否则行动价值=0。
3、如果受计方防御力是单降，行动价值=27。
4、如果受计方防御力是双降，行动价值=29。
5、如果是强阵，那么以受计方坐标为中心点，周围4格有n个防御力不是双升的人(n>=1)，行动价值再加10*n。
6、如果是强阵，那么中心点周围4格没有防御力不是双升的人，行动价值减4（最低为0）。
7、如果对自己使用，行动价值减1。
8、如果施计方的移动范围+攻击范围内没有敌人，那么行动价值=0。

（十七）对策
如果受计方没有减轻策略伤害的状态并且施计方的移动范围+攻击范围内有敌人，行动价值=13，否则行动价值=0。

（十八）回归
1、如果受计方回合结束，行动价值=15，否则行动价值=0。
2、如果对自己使用，行动价值=0。

（十九）升格
行动价值=0。

最后如果行动价值>0，那么：
1、如果受计方是我军或敌军主将，那么行动价值加10。
2、如果受计方是我军或敌军其他的有名字的武将，那么行动价值加6。
3、如果行动价值超过255，那么行动价值=255；如果行动价值低于0，那么行动价值=0。
4、如果受计方是仇人，行动价值加10。
5、有些变量会控制电脑操控部队策略的使用：
  (1)0x46A6DA处的值为0（初级难度），则：
  　 禁止使用对策、封策；
  　 禁止使用12~24号策略；
  　 步兵系、弓兵系、羌族兵不使用火系策略；
   　禁止在受计方攻防状态为单升或正常时使用奋起、鼓舞、坚固、强阵。
  (2)0x46A6DA处的值为1（中级难度），则：
   　禁止使用对策、封策；
   　禁止在受计方攻防状态为单升或正常时使用奋起、鼓舞、坚固、强阵。

---------------------------------------------------------------

这样就可以看出使用策略的大致优先级了（只考虑单体的策略）：

0、攻击类（致命） 80
1、觉醒 32
2、康复 31
3、奋起（双降时） 31
4、补给类 约30
5、奋起（单降时） 29
6、坚固（双降时） 29
7、进言类 28
8、解放 27
9、坚固（单降时） 27
10、轻功 26
11、止步 25
12、封策 24
13、牵制 23
14、假情报 22
15、攻击类（不致命） 20
16、反间 20
17、骂声 19
18、压迫 18
19、查看类 17
20、回归 15
21、对策 13
22、奋起（普通） 12
23、坚固（普通） 11

十一、坐标附加行动价值

战场上每个点都有其附加的行动价值，具体是：

0、附加行动价值=0。（赋初值）
1、如果部队耐久力较低（有名字的部队耐久力小于等于40%或没名字的部队耐久力小于等于20%），则移动范围内的恢复地形的附加行动价值+50.
2、若不是恢复地形，且地形加成>10，则附加行动价值加上 地形加成-10。
3、若是恢复地形，则附加行动价值加上 该地形耐久力恢复率/(5%)+3。
4、加上该附加行动价值后，总行动价值仍旧不能超过255。
5、在高级难度下，对于周围4格至少存在1个敌军的格子，该格行动价值减1。（最低为0）

十二、友军/敌军部队行动的顺序（以耐久力自动恢复后为准）

第1优先级：处于恢复地形的部队按照部队列表的顺序行动；
第2优先级：耐久力不多（有名字武将耐久力小于等于40%，无名小兵耐久力小于等于20%）的部队按照部队列表的顺序行动；
第3优先级：剩余部队的按照部队列表的顺序行动。

注：如果有人用了回归，则在此人执行完毕之后，按照上面的规则重新排序，剩下所有未执行的部队按照这个重排的顺序行动。

十三、伏兵出场位置被占时，出场的实际位置

如图，位置0为原先出场的坐标，如果位置n有人或不可移动地形或边界，则向位置n+1搜索，直到找到空位。

出于算法速度考虑，系统只能提供如果60个空位。如果这60个都被占，则系统出错。

十四、与目标坐标相关（仅适用于AI=0或4的部队）

（一）如果不存在仇人
1、目标坐标行动价值加10；
2、目标坐标周围4格行动价值都加9；（如果是炮车系则不加）
3、如果行动价值最大的几个坐标中包含目标坐标，则优先进入目标坐标。

（二）如果存在仇人
1、仇人周围4格行动价值都加10；（如果是炮车系则不加）
2、仇人的上2、右2、下2、左2、以及斜的4个格子行动价值都加9。（如果是炮车系则不加）

十五、电脑操控部队被包围后会干什么？

如果电脑操控部队满足以下所有条件，则按照7L的图逆序（即编号最大的优先）攻击敌人，如果攻击范围内没有敌人，就什么事都不干：

1、该部队的AI为0（移动）、1（攻击最近敌）或3（休息）；
2、该部队周围4格都是敌人或者不可移动地形，或者找不到任何物理攻击行动价值>0的攻击点；
3、此条为AI=0的附加条件，AI=1或3时无视该条：

    a)如果该部队存在仇人，且仇人不在周围4格中的任何一格；
    b)如果该部队不存在仇人，且其目标坐标不是周围四格中的任何一格。



如果不满足以上条件，则按原来的算法计算行动方式。

补充：
敌军物资队在他能行动的时候，会给他附近剩余策略值较少的部队自动恢复策略值（这应该算是电脑作弊吧）。具体是：

在每次计算进言/献策/施策的行动价值的时候，如果行动价值大于零，则会给这支部队偷偷恢复策略值（自己不耗策略值）。举例如下：

1、敌军某个物资队行动前，附近有另外一支敌军部队（不能是物资队），其策略值为1/255。
2、物资队等级为20，剩余策略值为30。（能够使用进言、献策）
3、那支部队周围的4格，其中3格物资队能移动到（设这3格按照消耗移动力从小到大依次为A、B、C）。
4、该回合物资队的AI要能移动。（被动状态下移动范围+攻击范围要有我军部队）

那么会进行以下处理：
1、在A格进行进言的行动价值计算，10*1/255<=4成立，行动价值大于零，则该部队的策略值偷偷恢复至1+20=21。
2、在A格进行献策的行动价值计算，10*21/255<=4成立，行动价值大于零，则该部队的策略值偷偷恢复至21+40=61。
3、在B格进行进言的行动价值计算，10*61/255<=4成立，行动价值大于零，则该部队的策略值偷偷恢复至61+20=81。
4、在B格进行献策的行动价值计算，10*81/255<=4成立，行动价值大于零，则该部队的策略值偷偷恢复至81+40=121。
5、在C格进行进言的行动价值计算，10*121/255<=4成立，行动价值大于零，则该部队的策略值偷偷恢复至121+20=141。
6、在C格进行献策的行动价值计算，10*141/255<=4不成立，行动价值等于零，则该部队不再偷偷恢复策略值。
7、如果有多支部队剩余策略值很少，那么都会进行上述操作。
8、如果计算完，判断行动价值最大的操作是在B格给这支部队“献策”，那么物资队会按照正常的程序移动到B格，然后正常地执行一次献策策略。
那么最后这支部队的策略值恢复到141+40=181，并且因为执行了献策，那么物资队会被扣掉24点策略值。

另外，都督会献策，皇帝会施策。那么也会进行上述计算。


从楼上的代码可以看出：

1、如果是好的状态（攻防上升、策略损伤减轻）

恢复某一个状态（去掉策略损伤减轻，去掉一阶攻防上升，二阶攻防上升降为一阶）要求

随机数%[(智力+防御力)/100+20]<=A

其中A的取值与兵种类型有关：
军师系、运粮队、物资队、军乐队、皇帝、都督、幻术师：1
步兵系、弓兵系、战车系、炮车系：2
骑兵系、弓骑兵系、贼兵系、武术家系：3
少数民族兵种、动物兵团：4

2、如果是坏的状态（攻防下降、混乱、耐久力每回合减少等）

恢复某一个状态（去掉不良状态，去掉一阶攻防下降，二阶攻防下降降为一阶）要求

随机数%[20-(智力+防御力)/100]<=B

其中B的取值与兵种类型有关：
军师系：10
运粮队、物资队、军乐队、皇帝、都督、幻术师：4
步兵系、弓兵系、战车系、炮车系：3
骑兵系、弓骑兵系、贼兵系、武术家系：2
少数民族兵种、动物兵团：1

天气变化的算法：

unsigned __int8 __fastcall sub_443C7E(int a1)
{
  unsigned __int8 result; // al@6
  unsigned __int8 v2; // al@1
  int v3; // [sp+Ch] [bp-Ch]@1
  unsigned __int8 v4; // [sp+14h] [bp-4h]@1
  unsigned __int8 v5; // [sp+10h] [bp-8h]@1

  v3 = a1;
  v2 = sub_447328(6);  //随机数%6
  v4 = v2;
  v5 = *(_BYTE *)(v3 + 4);  //天气代码地址
  if ( v5 <= (signed int)v2 )
  {
    if ( v5 < (signed int)v4 )
      ++v5;
  }
  else
  {
    --v5;
  }
  if ( v5 )
  {
    if ( v5 == 5 )
    {
      result = v3;
      *(_BYTE *)(v3 + 4) = 0;
    }
    else
    {
      result = v5;
      *(_BYTE *)(v3 + 4) = v5;
    }
  }
  else
  {
    result = v3;
    *(_BYTE *)(v3 + 4) = 5;
  }
  return result;
}

---------------------------------------------
释义：
A=0~5的随机数
B=上一回合天气

如果A>B，则B加1；如果A<B，则B减1。

如果B=5，则本回合天气=0；如果B=0，则本回合天气=5。

天气代码：00、01、02晴，03云，04、05雨

注：孔明传的天气算法与英杰传完全一致。


每回合开始，在恢复地形部队恢复耐久力的算法。

int __cdecl sub_42AB99(unsigned __int8 a1)
{
  int result; // eax@2
  unsigned int v2; // [sp+Ch] [bp-4h]@1

  v2 = a1;
  v2 -= 7;
  if ( v2 > 6 )
  {
LABEL_7:
    result = 0;
  }
  else
  {
    switch ( v2 )
    {
      case 0u:  //村庄
        result = sub_447328(5) + 10;  //恢复耐久力为最大耐久力的百分之(随机数%5+10)，下面类似
        break;
      case 1u:  //鹿砦
        result = sub_447328(5) + 15;
        break;
      case 2u:  //兵营
        result = sub_447328(5) + 5;
        break;
      case 3u:
      case 4u:
        goto LABEL_7;
      case 5u:  //城池
        result = sub_447328(5) + 25;
        break;
      case 6u:  //关隘
        result = sub_447328(5) + 20;
        break;
    }
  }
  return result;
}

注意：
1、最后的结果值不是恢复耐久力的值，而是恢复最大耐久力的百分比！！

2、如果同时处在恢复地形且持有自动回复的道具，则两种回复可以叠加；但是如果持有多个自动回复道具，则只取威力最大的一个。
具体是：剩余耐久力=剩余耐久力+地形恢复效果(也就是上面的result)*最大耐久力/100+道具恢复效果*最大耐久力/100

自动回复道具效果值：
三略10，六韬15，孟德新书20，孙子兵法25，不加随机数



《三国志孔明传》孔明红心谜团初步破解

感谢godtype找出存档文件里面孔明红心的位置，在0x818。

关于这个位置的值，我们设其为A。那么，开始新游戏的难度选择，其A值分别为：

初级：A=180
中级：A=100
高级：A=80

每一战开始时A值都要减1，撤退算一战。

红心数量与A值的关系为：
A值	红心个数
0	0
1~10	0.5
11~20	1
21~30	1.5
31~40	2
……	……
81~90	4.5
91+	5

《孔明传》兵种资料与练级分析

概论：
孔明传的兵种成长模式介于英杰传和曹操传之间，基本形态为“基本值+等级×兵种成长系数”。对我军而言，等级和能力总值之间的关系不太确定，因为要视乎玩家在什么时候升级。敌军的能力和等级严格相关。下面总体介绍一下。
先说敌军，敌军的能力和兵种、等级之间的关系是固定的，比如某个12级轻战车的武力=基本值+12×4，其中12是等级，4是轻战车武力每级的增长系数。那么如果是重战车，算法是这样的：比如25级的重战车，武力=基本值+15×4+10×3，即按照轻战车的标准先算到15级，然后转而按照重战车的增长系数计算（这里可以看出，兵种升级之后，增长系数未必增加，也能减少，后文详述）。如果是大型战车，那么就先按轻战车算到15级，再按中战车算到30级，再按大型战车的标准算。这里讲一个特例，假如出现等级特异的情况，比如阳平关之战当中9级的重战车曹真，那么算法是这样的，先按基本值和轻战车算到15级，然后再按重战车减回6级，所以会出现曹真智力=3的情况，呵呵。
说完敌军，说说我军。我军的情况比敌军复杂。当我军升级的时候，武力、智力、统御和策略值按照兵种成长正负1修正，还是举轻战车的例子，当轻战车马岱升级的时候，其武力增长量可能是3、4、5中的一个，即4正负1。唯一的例外是耐久力，我方兵种除后勤三兵种（物资、运粮、军乐）外，按照兵种增长系数的正1负5修正，比如轻战车的耐久力增长系数是13，那么马岱升级时耐久力增量会是8、9、10、11、12、13、14中的一个。对于我方而言，还有一个额外的小问题，即加入问题。当一个武将加入我军时，有两种情况，一种是剧情加入，比如马谡，另一种是战场加入，比如王平。战场加入比较简单，即此人原来是敌军，能力按照敌军的方式计算，加入我军之后就保持原来的能力。剧情加入稍微复杂，相当于一个武将1级加入我军之后再成长到当前等级，这里面有个小小的区别，即，战场加入的武将，按照公式“基本值+等级×兵种成长系数”，而剧情加入的武将，前面那个公式的等级要减1。


1.步兵、弓兵和贼兵：
这三个兵种的共同特点是，移动力中庸，耐久力也中庸，有一定的策略，所以放在一起说。
步兵三个阶段为短兵、长兵和近卫兵，其中短兵为四格攻击，长兵和近卫兵是八格攻击。
步兵的成长系数是：
        武力        智力        统御        耐久        策略
短兵        3        2        4        11        3
长兵        3        3        3        11        3
近卫兵        3        4        3        11        4
可以看出，随着兵种级别的提升，步兵的智力是一步一个台阶向上攀升，而防御力则仅在短兵阶段保持4，以后就下降一点。
步兵的策略为：
5    焦热
10   火龙
15   小补给
20   假情报
25   中补给
30   压迫
35   猛火
40   查看
45   大补给
这些策略都是非常实用的，也有利于练级。由于30级以后的策略对练级意义不大，而长兵已经可以8格攻击，所以为了练级起见，可以考虑不把长兵升为近卫兵。当然，这样做策略值方面是有点损失的，玩家可以自己权衡。

弓兵的三个阶段为弓兵、弩兵和连弩兵，弩兵和连弩兵的攻击范围较大。
弓兵的成长系数是：
        武力        智力        统御        耐久        策略
弓兵        3        3        2        11        2
弩兵        3        3        3        11        3
连弩兵        3        3        4        11        4
弓兵的防御力随着兵种提升而节节上升，策略值也不断增加。
弓兵的策略为：
5    焦热
10  火龙
20  假情报
30  骂声
35  猛火
由于没有补给类策略，弓兵练级较步兵稍显困难。

贼兵是两转兵种，依次是山贼和义贼。
贼兵的成长系数是：
        武力        智力        统御        耐久        策略
山贼        4        2        3        13        4
义贼        2        3        3        15        4
山贼和义贼的能力变化非常大，其中武力从4突降为2，而智力和耐久力有少许上升。
贼兵的策略为：
1  落石
8   山崩
13  大落石
16  压迫
19  山洪
22  奋起
25  大山崩
28  骂声
31  大山洪
34  坚固
贼兵的策略除了山类攻击性策略外，还有几个不错的辅助策略，不过义贼是我军除了后勤兵种以外仅有的武力成长系数为2的兵种，所以后期贼兵反击砍人可以砍很久，对练级相当地有好处，还可以把使用策略的机会让给队友。

2.骑兵、弓骑兵和炮车
这三个兵种的共同特点是，战斗力较强（真的是较强，不是很强，孔明传里比骑兵战斗力强的兵种不少），地形适应性差，没有策略，可以说是三大傻兵种。
骑兵三个阶段为轻骑兵、重骑兵和亲卫队。
骑兵的成长系数是：
        武力        智力        统御        耐久        策略
轻骑兵        4        0        3        17        0
重骑兵        4        2        3        17        0
亲卫队        3        2        4        17        0
出人意料的是，亲卫队的武力成长系数居然是下降的。
轻骑兵智力不会增加（弓骑兵和小炮车也是），这就给练级带来一个机会——如果保持智力永远不增加，培养成一个“傻瓜”（看来孔明传和英杰传一样需要傻瓜），后期敌军策略对我军骑兵的杀伤力就比较可观，带来的补给机会也就多。

弓骑兵三个阶段为弓骑兵、弩骑兵和连弩骑兵。
弓骑兵的成长系数是：
        武力        智力        统御        耐久        策略
弓骑兵        3        0        4        17        0
弩骑兵        4        2        3        17        0
连弩骑兵        4        2        2        17        0
弓骑兵也可以培养成傻瓜，不过和骑兵的区别还是有的。一方面，连弩骑兵的攻击范围比弓骑兵大得多，因此灵活性也大，另一方面连弩骑兵的防御力很差，适合挨打，所以可以考虑让弓骑兵升到30级，直接变连弩骑兵。

炮车三个阶段为小炮车、大炮车和霹雳车。
炮车的成长系数是：
        武力        智力        统御        耐久        策略
轻炮车        3        0        4        13        0
重炮车        3        2        3        13        0
霹雳车        4        2        2        13        0
炮车的情况和弓骑兵非常相似，也可以考虑小炮车到30级直接转霹雳车。

3.战车
战车单独列出，因为比较独特，值得一说。
战车可以装备马，也可以装备车轮。
战车三个阶段为轻战车、重战车和大型战车。
战车的成长系数是：
        武力        智力        统御        耐久        策略
轻战车        4        0        3        13        3
重战车        3        2        4        13        3
大型战车        3        2        4        13        3
战车的防御力相当高，从挨打补血的角度来说是不太有利的，不过智力不高，可以在一定阶段按“傻瓜”的标准培养。
战车的策略为：
12  压迫
24  小补给
36  止步
战车所会的策略不多，但全都是极好的练级策略。为了让战车尽量保持低智力，可以考虑让轻战车24级时才升重战车，这样智力和防御力都可以尽量低些。

4.武术家和虎兵团
武术家和虎兵团和虎兵团才是孔明传最BT的超级兵种，我方这两个兵种只有三流武将担任，不能不说是一种遗憾。
武术家是两转兵种，依次是武术家和大武术家。
武术家的成长系数是：
        武力        智力        统御        耐久        策略
武术家        5        2        4        15        0
大武术家        6        3        4        17        0
请注意，在孔明传我方可能拥有的兵种当中，大武术家的三围是最高的，而且武力成长系数6也是绝无仅有的，加上超强的地形适应能力和极高的二连击概率，武术家可谓是孔明传头号格斗兵种。以往的感觉是张嶷能和赵云魏延匹敌，那其实是在赵云魏延有等级优势的情况下的感觉，如果相同等级，赵云魏延在张嶷面前难以支撑。不过，话又说回来，武术家是孔明转中最难练的兵种，也是最妨碍同伴练级的兵种。

虎兵团是两转兵种，依次是虎兵团和猛虎兵团。
虎兵团的成长系数是：
        武力        智力        统御        耐久        策略
虎兵团        4        2        2        15        3
猛虎兵团        5        3        3        15        3
虎兵团的策略为：
1    压迫
6    假情报
11  止步
16  威压
21  伪兵
26  牵制
猛虎兵团的物理战斗能力在孔明传中已属上乘，而且可以一次攻击一直线，还会伪兵这样的BT策略，可谓是一个人抵一支军队。猛虎兵团练级比武术家容易得多，对同伴的妨碍也少，可惜也只有陈式、吴班之流可以练。

5.军师
军师孔明传主角的兵种，我方唯一获得第二个军师的机会是培养诸葛瞻。
军师三个阶段为军师、名军师和大军师。
军师的成长系数是：
        武力        智力        统御        耐久        策略
军师        2        4        2        9        5
名军师        2        4        2        11        6
大军师        2        5        2        13        7
升级兵种时，军师的攻防不会变化，这个练级带来很大的好处。随着军师耐久力成长系数的上升，高等级军师挨打会给同伴带来练级的极大方便。
军师的策略为：
1    焦热
3    落石
4    小补给
5    火龙
7    假情报
8    觉醒
9    压迫
11   大焦热
12   中补给
13   察看
15   猛火
16   康复
17   山崩
19   伪兵
20   对策
21   威压
23   大火龙
24   大补给
25   侦察
27   反间
28   轻功
29   骂声
31   止步
32   解放
33   山洪
35   谍报
36   全补给
37   流言
39   挑拨
40   封策
41   牵制
43   大猛火
军师所会的策略非常丰富，对练级的帮助很大。

6.后勤兵种
后勤兵种包括运粮队、物资队和军乐队，这三个兵种都不能进行兵种升级，而且行动能力差，地形限制多。根据玩家的喜好，我方有可能在很长时间里没有军乐队。
后勤兵种的成长系数是：
        武力        智力        统御        耐久        策略
运粮队        2        4        2        7        6
物资队        2        4        2        7        6
军乐队        2        4        2        7        6
可见，这三个兵种的成长性是一模一样的，武将之间的区别仅仅在于基本值。
运粮队的策略为：
1   小补给
7   中补给
13  援队
19  大补给
25  援部
31  全补给
37  援军
43  援国
运粮队的核心策略是援队，靠着这个策略，每回合升一级不是梦。

物资队的策略为：
1   进言
4   查看
8   压迫
12  坚固
16  献策
20  升格
24  侦察
28  威压
32  谍报
36  施策
40  强阵
“物资队其实不好练”，呵呵。不过，升格这个策略能省下不少钱，买援队书吧，算是物资队交党费了。

军乐队的策略为：
1    奋起
4    觉醒
8    骂声
12   康复
16   回归
20   挑拨
24   解放
32   鼓舞
军乐队也是为人民服务型的兵种，能恢复身边部队的策略值，并且有回归这样的策略。没有军乐队的日子里，练级是件苦差事。

7.南蛮兵种
南蛮兵种也不能升级，不过在攻防和策略方面都有不错表现。
后勤兵种的成长系数是：
        武力        智力        统御        耐久        策略
南蛮兵        4        2        3        13        4
南蛮骑兵        4        2        5        16        3
应该说，南蛮骑兵的战斗力还是相当可观的。
南蛮兵种的策略为：

南蛮兵
1    落石
15  山崩
30  山洪

南蛮骑兵
1    小补给
15  中补给
30  大补给
南蛮兵的策略比贼兵简化，能力也不理想，不如练贼兵。南蛮骑兵天生有小补给，不管作为敌军还是我军出场，都是练级的福音。

注意南蛮骑兵，貌似12级之前和之后的武力成长不一样。

另外小炮车直接变霹雳车的做法不可取，因为这样的话15到30级之间练级会很慢，大炮车可以打5个。
初期中期会用策略的敌人不多，而大炮车霹雳车由于会打很多人而可以被拖后出场以压缩出场数，利用等级差疯狂升级。

怒赞资料帖！！！！！！

谈几点自己的想法：
（1）没想到贼兵攻击那么低，看来是反击的好选择。
（2）霹雳车和大炮车攻击范围相同，但攻高防低，由于该兵种主要靠主动攻击练级，且级别不太可能领先，所以是否可以考虑一直用大炮车，到99或者数值满的时候再转？
（3）物资队只是早期不好练。根据我后来计算的结果，策略满经验稳定后，还是很不错的~而且其辅助功能也非常强大，如果诸葛瞻转军乐队（似乎只有如此到99希望才比较大），那么物资队将是助其升级的好帮手。有时马岱、陈式等策略不够用的时候，物资队也能帮上忙。
（4）养傻瓜我以为不可取，因为游戏中级别高的几乎都是用策略的文官，所以补给傻瓜并不能得到多少经验值。马岱或许是个例外，然则伊已经够傻了，12级后的压迫命中率很低就是个恶果。
（5）虎兵团的防御力相当低，未变兵种前和后勤系一样，因此如果把他们练上去了，对物理损失进行补给，才是经验值的良好来源。

大炮车打5个人，而霹雳车是打9个人，所以30级了还是立即转为霹雳车好。

另外说一下诸葛瞻四次的培养意见的系统处理应该是：
初始是1级，第一次培养到7级，之后每次培养升7级，直到28级出场。
而培养的每一项都会把他转为某一个兵种进行升级。
具体估计是：像刘备/学剑术——短兵，像自己/学兵法——军乐队，像赵云/马术——轻骑兵。直到长安之前自选兵种。

发几个无聊的成长：

幻术师：2/4/2/9/5
都督：5/5/5/17/6
皇帝：5/5/5/17/未知
藤甲、羌族、象、蛇：4/2/3/13/4

另外补一下：若某个兵种的某个属性成长为0，则不再有随机浮动，就是0。

皇帝的策略值成长是6。

目前初步结论，小补给值=20+智力/2。

目前得到的焦热公式是：
伤害=（A+0.4*智力差）*被害兵种系数+B
其中A是策略伤害基本值，B是随机修正值，应该是个个位数。由于B的存在，使A不太好确定，确信应该是20或25之一。
被害兵种系数是受计方兵种的系数，目前知道步兵、弓兵、武术家是1，骑兵是0.8，弓骑、战车、炮车、后勤兵种都有不同程度的向下修正。
这个公式是在平原上得到的，所以不包含地形修正系数。

从这个结论看，贼兵受石系策略被害减小的可能性比较大。

另外，由于孔明传是伪随机函数游戏，所以测试时请保证参与计算的是同一个伪随机数（即步骤完全相同）。

目前测试双方相同兵种在相同地形攻击的伤害公式：轻骑兵、平原：1.3攻-0.8防；亲卫队：1.2攻-0.6防。反击50％，暴击150％。

挖坑的事迟点再说，先解释敌军能力设置。

先看成长表格：
名称      武 智 防 HP  MP
短兵      2  1  3  10  2
长兵      2  2  2  10  2
近卫兵    2  3  2  10  3
弓兵      2  2  1  10  1
弩兵      2  2  2  10  2
连弩兵    2  2  3  10  3
轻骑兵    3  0  2  16  0
重骑兵    3  1  2  16  0
亲卫兵    2  1  3  16  0
轻战车    3  0  2  12  2
重战车    2  1  3  12  2
大战车    2  1  3  12  2
小炮车    2  0  3  12  0
大炮车    2  1  2  12  0
霹雳车    3  1  1  12  0
弓骑兵    2  0  3  16  0
弩骑兵    3  1  2  16  0
连弩骑兵  3  1  1  16  0
军师      1  3  1  8   4
名军师    1  3  1  10  5
大军师    1  4  1  12  6
山贼      3  1  2  12  3
义贼      1  2  2  14  3
武道家    4  1  3  14  0
大武道家  4  2  3  16  0
虎使      3  1  1  14  2
猛虎使    4  2  2  14  2
食粮队    1  3  1  6   5
物资队    1  3  1  6   5
军乐队    1  3  1  6   5
南蛮兵    3  1  2  12  3
南蛮骑兵  3  1  4  15  2
皇帝      4  4  4  16  5
注意与前面的各楼提到的资料是不同的，这个才是真正的成长。
其他兵种成长值：总司令官跟皇帝一样；幻术师跟军师一样；其他异族兵跟南蛮兵一样。

能力计算的时候要分低中高级兵种，比如短兵是低级、长兵是中级、近卫兵是高级，山贼等只有低中两级，而南蛮骑兵属于中级。

如果是高级兵种，
第1步是按对应的低级兵种的成长值A+A*2+3计算出一个B值，然后再按B+B*4计算出一个C值，接着等级值减15；
第2步是按对应的中级兵种的成长值D+D*2+3计算出一个E值，然后再按E+E*4计算出一个F值，并加进C值里面，接着等级值再减15；
第3步是按自身兵种的成长值G加1，然后乘以等级值（注意已经减去了30），并加进C值里面，此时的C值就是最终的成长，加上初始能力就是最终出场的能力了。

如果是中级兵种就省去上面的第2步。没转职兵种就只按第3步计算。

如果成长值为0则跳过对应步骤中能力计算部分，但是等级值同样要减去。

以42楼的孟获的武力为例，
第1步，南蛮兵的武力成长为3，B=3+3*2+3=12，C=12+12*4=60，孟获等级为10，减15后得-5；
第2步，南变骑兵的武力成长为3，(3+1)*(-5)+60=40
孟获初始武力为23，所以最终出场的武力为23+40=63

解释结束。

我军加入能力计算（包括战场中升级）

首先要判断升级量，比如新加入武将，以最初的刘备为例，5级登场，所以升了4级。
但是升级量不一定是升多少级，如果 武将当前等级 <= (99-升了多少级) 的时候，升级量才是升了多少级，比如上面说的刘备，这里升级量就是4了；
如果 武将当前等级 > (99-升了多少级) 的时候，升级量 = 99 - 武将当前等级。（我觉得很奇怪，有没有人碰到这种情况？）

接下来是计算武力、智力、防御、MP的随机数，HP的不在这里计算。
根据升级量来循环计算，每次循环，四项随机数都会产生-1、0、+1的变化（初始都是0），比如前面的刘备，升级量是4，所以循环了四次，所以四项能力会产生-4~+4之间不同的随机数值。

再接下就是计算实际能力了，非HP的如果成长值不为0，实际能力 = (成长值+1)*升级量+随机数+原来的能力。注意不超过最大值，HP为1000，其余为255。

HP的计算是这样的：当成长值不为0时，随机取出少于(成长值+11)的数值中的一个数，比如前面的刘备，短兵的成长值是10，就要从0~20中随机取出一个数出来，然后这个随机数除以4，这个数先称为A值；
然后是成长值+成长值*2（其实就是成长值*3），得出来的数除以4后加在A值里面；
最后 A值*升级量+原来的能力 就是实际的HP了。

关于敌人加入的等级，函数竟然如此复杂。可以简化一下吧

如果是高级兵种，
第1步是按对应的低级兵种的成长值A+A*2+3计算出一个B值，然后再按B+B*4计算出一个C值，接着等级值减15；
A+A*2+3 = 3*A+3
C = B+B*4 = 5*B = 5*(3*A+3) = 15 * (A+1)
简单的说，就是按照低级兵种成长值+1来算15次

第2步是按对应的中级兵种的成长值D+D*2+3计算出一个E值，然后再按E+E*4计算出一个F值，并加进C值里面，接着等级值再减15；
D+D*2+3 = 3*D+3
F=E+E*4 = 5*E = 5*(3*D+3) = 15 * (D+1)
简单的说，就是按照中级兵种成长值+1来算15次

第3步是按自身兵种的成长值G加1，然后乘以等级值（注意已经减去了30），并加进C值里面，此时的C值就是最终的成长，加上初始能力就是最终出场的能力了。
简单的说，就是按照自身兵种成长值+1，乘上等级。

结论：

如果是高级兵种，那么最终值相当于按照低级兵种升级了15级，然后又按照中级兵种升级了15级，再按照最高级兵种升级了剩余的等级。如果当前兵种不足30级，则倒扣到相应等级。
如果是中级兵种，那么最终值相当于按照低级兵种升级了15级，再按照当前兵种升级了剩余的等级。如果当前兵种不足15级，倒扣到相应等级。
所有的地方兵种的升级，都已标准升级值+1来计算。

猪猪版三国志孔明传的兵种攻防升级能力修改(附修改器下载)

本贴讨论了关于孔明传中一些数据的存放位置，现在顶楼汇总一下。感谢各位大大的鼎力支持。

EXE文件：
请下载http://www.xycq.net/forum/thread-198087-1-1.html中的破解执行文件。
或者使用godtype大大的全兵种适用道具exe文件( http://www.xycq.net/forum/thread-210699-1-2.html )

一、兵种升级属性位置
0x4eb70~0x4eb90 武力
0x4eb91~0x4ebb1 智力
0x4ebb2~0x4ebd2 统御力
0x4ebd3~0x4ebf3 生命值
0x4ebf4~0x4ec17 策略值
0x4ec18~0x4ec3f 移动力

共有40个兵种，但是攻防智耐策等升级只定义前33个兵种的(到皇帝为止)。
移动力定义了前39个兵种，没有北狄兵的。
兵种的顺序：
第0~32
短兵、长兵、近卫兵、弓兵、弩兵
连弩兵、轻骑兵、重骑兵、亲卫队、轻战车
重战车、大战车、小炮车、大炮车、霹雳车
弓骑兵、弩骑兵、连弩骑兵、军师、明军师
大军师、山贼、义贼、武术家、大武术家
虎兵团、猛虎兵团、运粮队、物资队、军乐队
南蛮兵、南蛮骑兵、皇帝

第33~38
都督、藤甲兵、羌族兵、象兵团、蛇兵团、幻术师

第39
北狄兵

没有定义的兵种继承前32个兵种的升级属性
都督->皇帝
藤甲兵、羌族兵、北狄兵->南蛮兵
幻术师->军师
象兵团、蛇兵团未知

二、兵种的攻击范围
0x51F28H~0x51f4fH共计40个字节表示40个兵种的攻击范围
00 表示周围4格（骑兵）
01 表示周围8格（战车）
02 表示周围空一格的4格（弓兵）
03 表示周围空一格的全周范围（弩兵）
04 表示周围空两格的全周范围（炮车）

三、兵种的攻击速度
从0x51F50H~0x51F7H 是兵种的攻击速度，根据后来各位大大分析的结果，攻击速度关系到暴击率，连击率/被连击率。
短兵：4
长兵：5
近卫兵：6
弓兵：4
弩兵：5
连弩兵：6
轻骑兵：5
重骑兵：6
亲卫队：7
轻战车：3
重战车：3
大战车：3
小炮车：2
大炮车：2
霹雳车：2
弓骑兵：5
弩骑兵：6
连弩骑兵：7
军师：4
名军师：4
大军师：4
山贼：5
义贼：5
武术家：8
大武术家：10（这个BT）
虎兵团：6
猛虎兵团：8
运粮队：3
物资队：3
军乐队：3
南蛮兵：5
南蛮骑兵：7
皇帝：7
都督：7
藤甲兵：5
羌族兵：5
象兵团：2
蛇兵团：5
幻术师：4
北狄兵：5

四、兵种的地形移动力消耗
地形的顺序是：(一个循环23个字节)
平原 草原 树林 荒地 山地 城内 桥梁 村庄 鹿寨 兵营 粮仓 宝库 城池 关隘 民宅 城门 栅栏 河流 岩山 火焰 泥流 ？？ ？？
0x51cc0~0x51cdf 是地形移动力的兵种共用关系，一共有00~0c计13中类型。
0x51CF0~0x51E1A 是部队在地形的移动力消耗

默认兵种系的顺序是：
0x51CF0: 步兵、弓兵、军师、皇帝、都督、幻术师
0x51D07: 骑兵系、弓骑兵系
0x51D1E: 战车系
0x51D35: 炮车系
0x51D4C: 贼兵系
0x51D63: 武道家系
0x51D7A: 虎兵团系
0x51D91: 运输队、物资队、军乐队
0x51DA8: 南蛮兵、藤甲兵、羌族兵、北狄兵
0x51DBF: 南蛮骑兵
0x51DD6: 象兵
0x51DED: 皇帝/都督
0x51E04: 蛇兵

FF表示该地形下不能移动


五、兵种的地形加成
0x51e20~0x51e47 是地形加成的兵种共用关系，一共有00~0c计13中类型。
17种地形：平原 草原 树林 荒地 山地 城内 桥梁 村庄 鹿寨 兵营 粮仓 宝库 城池 关隘 民宅 城门 栅栏

默认兵种系的顺序是：
0x51e48 步兵、弓兵、军师、幻术师
0x51e59 骑兵系、运输队、物资队、军乐队
0x51e6a 战车系
0x51e7b 炮车系
0x51e8c 弓骑兵系
0x51e9d 贼兵系
0x51eae 武道家系
0x51ebf 虎兵团系
0x51ed0 南蛮兵、藤甲兵、羌族兵、北狄兵
0x51ee1 南蛮骑兵
0x51ef2 皇帝/都督
0x51f03 象兵
0x51f14 蛇兵

0A表示100%(无加成)
0B表示110%
09表示90%

六、兵种所适用的装备
请参照http://www.xycq.net/forum/thread-210699-1-2.html修改，或者下载godtype修改后的exe文件再进行设定

默认情况下:
00        低档剑
01        中档剑
02        高档剑
03        低档枪
04        中档枪
05        高档枪
06        低档弓
07        中档弓
08        高档弓
09        低档炮
0a        中档炮
0b        高档炮
0c        低档扇
0d        中档扇
0e        高档扇
0f        低档虎
10        高档虎
11        低档爪
12        高档爪
13        乐器
14        粮车
15        铠甲
16        盾
17        马匹
18        车辆

在UE中把0xC278位置的数字改小，可以让小于15H的武器变为防具，而数值上也会增加防御力。
0xC278: 定义为防具类别的道具种类最小值(小于此数字皆为武器)
0xC28d: 定义为防具类别的道具种类最大值(大于此数字后为车马)
0xC2A2: 定义为车马类别的道具种类最大值(大于此数字后就是辅助类)


七、商店出售物品
前26个城市有物品出售。每个商店15个字节对应最多15种商品出售
0x52448~0x525cc 武器屋
0x525d0~0x52755 道具屋
0x4fd20~0x4ffdd 城市名

八、bakdata中武将的初始数据
bakdata有每个武将的初始数据，以0x3af0H诸葛亮的数据开始
０６　　０Ａ　　１８　　２Ｄ　　２Ｃ　００　　２８　　００　　１２　　０１　　００　　　88 ff ff ff ff ff ff ff ff ff ff ff ff ff ff
阵营　　武力　　统御力　智力　　耐力　　　　　策略　　　　　　职业　　等级　　经验值　　15个道具位置(诸葛亮自带蒲扇)

九、策略相关

策略名文字地址：0x4d1f0~0x4d2af 。如果需要扩展策略名的字数，可以在这里改

策略名文字：0x4db5c~0x4dcdb

策略施放范围：0x4D2B0~0x4d2df

00 表示焦热范围
01 表示火龙范围
02 表示猛火范围
03 表示小补给范围

策略的消耗：0x4D2E0~0x4d30f

0x4d318~0x4da97 每个兵种学习到每种策略的等级。00为学不会
每个计策对应40种兵种，占用40个字节

策略的说明文字：0x4dcdc~0x4e46f

十、道具的说明文字

道具名在bakdata.e2中修改，比较直观。

道具的说明文字在exe文件中

0x4ffe0~0x5017b是说明文字的地址定义。如果想要让说明文字长度增加，可以考虑修改这里。
0x5017c~0x51247是说明文字的具体地址。

十一、剧本中的敌军出场设定

剧本破解请参照
http://www.xycq.net/forum/thread-193072-1-1.html
每关的敌军出场位置如下：
每场战役有多个位置的，表示战前的选项不同，敌军的出场位置会有不同。22 00是设定出场的code

SNR0D.E2
博望坡战役：0x1672 0x1C83 0x221f 0x295f
新野战役：0x356B 0x3975
江夏急行战：0x40b1
长坂坡之战：0x47ab

SNR1D.E2
赤壁之战I：0xf1e
赤壁之战II：0x1485 0x1809
荆州南部战：0x27dd
绵竹、葭萌关战役：0x36f5
汉水之战：0x463b
麦城之战：0x5951
彝陵之战：0x6e3f

SNR2D.E2
阳平关之战：0x7d1
益州南部战：0x1577
玉溪峰之战：0x210f 0x24c7
夹山谷之战：0x2ca4
泸水之战：0x3247 0x3d97 0x41f6
西耳湖战役：0x4d4c 0x51f8
秃龙洞战役：0x5c76 0x6223
三江城战役：0x6d65
蛮都战役：0x75d7
桃叶江战役：0x7ff2
盘蛇谷战役：0x8a21

SNR3D.E2
风鸣山之战：0xc7a 0x1145
南安安定之战：0x1910 0x1eaa
天水城之战：0x283e 0x2ccc
冀城之战：0x3505 0x3a25
祁山之战：0x46bd 0x4d69
西平关之战：0x5624 0x5c2f
街亭之战：0x69a1
汉中退却战：0x6f96

SNR4D.E2
陈仓祁山之战：0xb6c 0x1004
陈仓攻城战： 0x18b6 0x1d61
祁山追击战： 0x2796 0x2d0b
二谷道之战：0x3d98 0x42ac
祁山之战2：0x4bb2
渭水之战：0x649a 0x69ea
葫芦谷之战： 0x71ea 0x78c9
五丈原之战：0x81c4 0x8a05

SNR5D.E2
眉城战役： 0x841 0xd56
武功战役：0x1562 0x1a83
长安攻城战1：0x2c3a
巴西之战：0x3e8c[孟获为敌军] 0x40cd[孟获为我军]
白帝城之战：0x49b4 0x4f50
江陵之战：0x5769
建宁之战：0x5ff4
长安攻城战2：0x76f1
华山之战： 0x812e 0x863d
函谷关之战：0x8e53 0x9384
洛阳之战1：0x9da1
洛阳之战2：0xa446

打开剧本文件，找到武将出场的地方。距离说明泸水之战，孟获逃窜
B6 00  
武将ID ：孟获

1b 10
横坐标，纵坐标

00 00 01
未知(似乎有面朝的方向)

00
直接出场(01表示隐藏)

06
将领AI，06表示逃窜

02 04
逃窜的目的地坐标(2,4)

1f
兵种：南蛮骑兵

0b
等级：11级

00 00 00 00 00 00
每个将领最后都有6位00分隔


目前已知的AI代码：
00：防守模式。如果移动范围+攻击范围内有我军就出击，否则不动。
01：攻击模式。如果移动范围+攻击范围内有我军就出击，否则向我军最近的目标移动。
02：坚守模式。不会移动，如果攻击范围内有我军就攻击。很多关敌军主将的AI。
03：追击模式。如果移动范围+攻击范围内有我军就出击，否则向指定的我军目标移动。后两个字节是追击的目标武将ID。比如说麦城之战追击关羽
04：行军模式。如果移动范围+攻击范围内有我军就出击，否则就向指定坐标移动，到达目标后切换为防守模式。后两个字节是目的地的坐标。敌军攻打我方城池采用的AI。
05：追随模式。如果移动范围+攻击范围内有我军就出击，否则向目标的坐标移动。后两个字节是跟随目标武将的ID。比如赤壁之战II中，曹军将领的AI
06：逃跑模式。不会主动攻击，只会朝指定目的地移动，如果没有路径可以通向目的地则原地发呆。后两个字节是逃跑的目的地坐标。比如说赤壁之战II的曹操。

————————————————————————————————————————————————————————————————————————————

我自己做了个修改器

我申请了个网盘在http://docs.baihui.com
用户名: lewulezo_share
密码: share

登录上去可以下载。

修改前请备份你的ekd2w95.exe和bakdata.e2，以及相关的剧本或存盘文件，否则改坏了我可不管哦。
因为我是用java写的，所以如果没有装java的话就要去装一个。(http://www.java.com)
点击ekd2mod.jar可以直接运行。

最新更新: 2010-07-27
1. 在现成的exe上打上godtype的"兵种装备自由设定补丁"的功能。如果要修改兵种属性也会提示打上补丁。
2. 在现成的exe上打上ctermiii 的"兵种相克自由设定补丁"的功能。如果要修改兵种相克属性也会提示打上补丁。
3. 提供兵种相克设定的功能。
4. 修改多处bug。

全道具类型
00        剑
01        剑
02        剑
03        枪
04        枪
05        枪
06        弓
07        弓
08        弓
09        炮
0a        炮
0b        炮
0c        扇
0d        扇
0e        扇
0f        虎
10        虎
11        爪
12        爪
13        乐
14        粮
15        甲
16        盾
17        马
18        车
19        火策略书
1A        地策略书
1B        查看
1C        压迫
1D        骂声
1E        假情报
1F        反间
20        牵制
21        恢复HP
22        恢复MP
23        恢复
24        奋起
25        坚固
26        对策|回归
27        转职
28        果种
29        经验
2A        兵书

我认为你说的不错
0x51F28H~0x51f4fH共计40个字节表示40个兵种的攻击范围
00 表示周围4格（骑兵）
01 表示周围8格（战车）
02 表示周围空一格的4格（弓兵）
03 表示周围空一格的全周范围（弩兵）
04 表示周围空两格的全周范围（炮车）

从0x51F50H~0x51F7H 我有点怀疑是兵种的攻击速度，类似于曹操传的爆发力，关系到命中率/回避率、双击率/被双击率。
短兵：4
长兵：5
近卫兵：6
弓兵：4
弩兵：5
连弩兵：6
轻骑兵：5
重骑兵：6
亲卫队：7
轻战车：3
重战车：3
大战车：3
小炮车：2
大炮车：2
霹雳车：2
弓骑兵：5
弩骑兵：6
连弩骑兵：7
军师：4
名军师：4
大军师：4
山贼：5
义贼：5
武术家：8
大武术家：10（这个BT）
虎兵团：6
猛虎兵团：8
运粮队：3
物资队：3
军乐队：3
南蛮兵：5
南蛮骑兵：7
皇帝：7
都督：7
藤甲兵：5
羌族兵：5
象兵团：2
蛇兵团：5
幻术师：4
北狄兵：5

0x51CF0H~0x51E1AH 经过验证是部队在地形的移动力消耗
地形的顺序是：(一个循环23个字节)
平原 草原 树林 荒地 山地 城内 桥梁 村庄 鹿寨 兵营 粮仓 宝库 城池 关隘 民宅 城门 栅栏 河流 岩山 火焰 泥流 ？？ ？？

FF表示该地形下不能移动

兵种系的顺序是：
51CF0H: 步兵系、弓兵系、军师系
51D07H: 骑兵系、弓骑兵系
51D1EH: 战车系
51D35H: 炮车系
51D4CH: 贼兵系
51D63H: 武道家系
51D7AH: 虎兵团系
51D91H: 运输队、物资队、军乐队
51DA8H: 南蛮兵
51DBFH: 南蛮骑兵
51DD6H: 象兵
51DEDH: 皇帝/都督
51E04H: 舰船

全物品列表：
00 焦热书 01 火龙书 02 猛火书 03 大焦热书 04 大火龙书 05 大猛火书
06 落石书 07 山崩书 08 山洪书 09 大落石书 0A 大山崩书 0B 大山洪书
0C 查看书 0D 侦查书 0E 谍报书 0F 压迫书 10 威压书 11 骂声书
12 挑拨书 13 假情报书 14 伪兵书 15 反间书 16 流言书 17 牵制书
18 止步书 19 恢复豆 1A 恢复麦 1B 恢复米 1C 恢复肉 1D 援队书
1E 援部书 1F 援军书 20 援国书 21 药 22 中药 23 华佗药
24 苏醒书 25 恢复书 26 释放书 27 轻功书 28 奋起书 29 鼓舞书
2A 坚固书 2B 强阵书 2C 对策书 2D 回归书 2E 没有 2F 封策书

30 短剑 31 刀 32 长刀 33 两刃剑 34 雌雄双剑 35 倚天剑
36 弯刀 37 斩马剑 38 三尖刀 39 神刀 3A 七星剑 3B 古淀刀
3C 大刀 3D 三色宝剑 3E 青釭剑  3F 古灵剑 40 英雄之剑 41 霸王之剑

42 棍棒 43 枪 44 钩 45 戟 46 蛇矛 47 青龙偃月刀
48 长枪 49 半月枪 4A 狼牙棒 4B 长戟 4C铁戟蛇矛 4D 铁蒺藜骨朵
4E 铁鞭 4F 大斧 50 流星锤 51 双铁戟 52 方天画戟 53 项羽矛

54 竹木弓 55 半弓 56 石弓 57 长弓 58 蛮弓 59 优弓
5A 良弓 5B 弹弓 5C 弩 5D 强弩 5E 连发弩 5F 元戎弩
60 名弓 61 十矢弩 62 诸葛弩 63 神弓 64 吕布弓 65 青龙弓

66 小石弹炮 67 石弹炮 68 手炮 69 泥弹炮 6A 岩石弹炮 6B 破裂弹炮
6C 火弹炮 6D 旋风炮 6E 玄武炮 6F 虎 70 黑虎 71 饿虎
72 猛虎 73 双眼虎 74 白虎 75 青铜爪牙 76 铁制爪牙 77 白银爪牙
78不败爪牙 79 大鹰爪牙 7A 朱雀爪牙 7B 笙 7C 征 7D 笛
7E 萧笛 7F 铜锣 80 鼓 81 单轮车 82 双轮车 83 三轮车
84 四轮车 85 木牛 86 流马 87 铁扇 88 蒲扇 89 阵扇
8A 银扇 8B 军扇 8C 鹤羽扇 8D 鹰羽扇 8E黑羽扇 8F 白羽扇

90 皮甲 91 青铜甲 92 锦铠 93 环锁铠 94 铁甲 95 两裆铠
96 赤甲 97 弥裆铠 98 明光铠 99 黑光铠 9A 筒袖铠 9B 将军铠
9C 白银制铠 9D 黄金制铠 9E 高祖铠 9F 蚩尤铠 A0 木制盾 A1小型盾
A2 皮盾 A3 滕盾 A4 青铜盾 A5 铁制盾 A6 大盾 A7 手牌
A8 圆牌 A9 燕尾牌 AA 推牌 AB 步兵旁牌 AC 无敌神牌 AD 神兽盾
AE 咒文盾 AF 鬼神盾 B0 粟毛马 B1 苇毛马 B2 黄骠马 B3 白马
B4 绝影 B5 爪黄飞电 B6 的卢 B7 赤兔马 B8 人车 B9 牛车
BA 大车 BB 马车 BC 轻车 BD 双牛车 BE 双马车 BF 疾风马车

C0 长兵器指南书 C1 近卫兵心得 C2 弩的奥秘 C3 连弩的奥秘 C4 马镫 C5 近卫马镫
C6 战车战术读本 C7 战车战术其二 C8投石机 C9 投石车 CA 弩骑兵镫 CB 连弩骑兵镫
CC 侠义精神 CD 武道全书 CE 猛虎鞭 CF 牙旗 D0 龙牙旗 D1 仁爱种
D2 武勇种 D3 智谋种 D4 根性种 D5 精神种 D6 经验种 D7 仁爱果
D8 武勇果 D9 智谋果 DA 根性果 DB 精神果 DC 经验果 DD 三略
DE 六韬 DF 孟德新书 E0 孙子兵法

52457H--52755H应该是商店出售的物品

三国孔明传物理伤害分析

兵种以及地形等相关内容就不写了，这个老兄的帖子应该是比较详细的：
http://www.xycq.net/forum/thread-210344-1-1.html

按照攻击的视觉流程来写
Random标示随机数
%标示求余，比如A>1时，Random%A表示拿一个随机数去求除以A的余数，显然余数在0~（A-1）之间，A=1时显然%A=0
因为都是整数运算，所以除法等相关运算都是不包括小数部分的。

这个游戏是没有命中率的概念的，因为很多因素会导致伤害为0，显示xxx没有受到伤害。

1、判断攻击是物理攻击还是策略攻击；

具体位置：

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
00423914  |.  8A48 12       MOV CL,BYTE PTR DS:[EAX+12]
00423917  |.  83F9 01       CMP ECX,1          ；;  物理攻击1还是策略伤害2，其实还有第3种伤害，后边说明

2、伤害A计算：
A、1 如果Random%(攻方攻击力x攻方所在地形因素/10)<防御方防御力x防御方地形因素/10/10
并且防御方没有混乱，那么伤害A=0，（猜测：攻击方如果是敌人，那敌人是不会来打的，他似乎会实现有个模拟运算攻击过程，见下边程序注释处）
A、2 如果Random%(攻方攻击力x攻方所在地形因素/10)>=防御方防御力x防御方地形因素/10/10
那么又分为：
A、2-1：如果(防御力x地形因素/10+1)/2>攻击方攻击力x攻击方所在地形因素/10
那么伤害A=1；
A、2-2：如果(防御力x地形因素/10+1)/2<攻击方攻击力x攻击方所在地形因素/10
那么伤害A=攻击力x地形因素/10-防御力x地形因素/10/2
B、判断防御方兵种：
B、1：如果兵种代号为09，0A、0B时，伤害A=Ax75%；
B、2：如果兵种代号为1B、1C、1D时，伤害A=Ax150%；
B、3：如果兵种代号1E、1F时，伤害A=Ax50%；
B、4：如果兵种代号为22时，伤害A=1；

结论是：
除了几个特殊兵种怕或者不怕物理攻击外，没有什么相克关系
具体代码见6楼：

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
http://www.xycq.net/forum/viewth ... page%3D1#pid2991476

3、判断是范围攻击类第一次攻击伤害还是反击，如果非第一次攻击，或者为反击，则上边计算的A=A/2；
注：如果到目前为止，伤害计算为0，则跳过下边5、6条过程

代码部分：

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
0042393C  |.  837D 08 01    CMP DWORD PTR SS:[EBP+8],1               ;  >=1为范围类伤害第一次之后的伤害
00423940  |.  0F83 11000000 JNB EKD2Win.00423957
00423946  |.  8B45 EC       MOV EAX,DWORD PTR SS:[EBP-14]
00423949  |.  33C9          XOR ECX,ECX
0042394B  |.  8A48 13       MOV CL,BYTE PTR DS:[EAX+13]              ;  1反击0攻击
0042394E  |.  83F9 01       CMP ECX,1
00423951  |.  0F85 0C000000 JNZ EKD2Win.00423963
00423957  |>  8B45 FC       MOV EAX,DWORD PTR SS:[EBP-4]
0042395A  |.  99            CDQ
0042395B  |.  2BC2          SUB EAX,EDX
0042395D  |.  C1F8 01       SAR EAX,1                                ;  原伤害变为50%
00423960  |.  8945 FC       MOV DWORD PTR SS:[EBP-4],EAX

4、无论前边攻击计算是否造成伤害，特效都会进行判断；
象兵和蛇兵的兵种攻击特效（附加异常状态跟策略附加异常状态调用的计算函数一样）如下：
A、反击不会带特效

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
0042377A  |.  8A48 13       MOV CL,BYTE PTR DS:[EAX+13]              ;  是攻击还是反击？反击为1攻击为0
0042377D  |.  83F9 01       CMP ECX,1
00423780  |.  0F85 05000000 JNZ EKD2Win.0042378B

B、已经混乱的不能被象兵再次混乱，已经有减血状态的不能被蛇兵再次附加减血状态；
C、有减轻策略伤害的buffer在的话，被附加异常状态buffer的几率减少，算法是仅仅增加跟随机数比较的“赌博”机会而已
2次都成功才可附加状态，意思就是说，第一次计算如果附加了状态，没有buffer的话就算是附加异常状态了，但如果有减轻策略损伤的buffer在，会再计算一次
如果成功才能附加异常状态，如果失败将不附加异常状态
更详细的注释看这里：
http://www.xycq.net/forum/viewth ... page%3D1#pid2996066

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
0040227F  |.  C645 EC 01    MOV BYTE PTR SS:[EBP-14],1     ；普通状态给1次赌博机会
00402283  |.  6A 08         PUSH 8                                   ; /Arg1 = 00000008
00402285  |.  33C0          XOR EAX,EAX                              ; |
00402287  |.  8A45 0C       MOV AL,BYTE PTR SS:[EBP+C]               ; |
0040228A  |.  8BC8          MOV ECX,EAX                              ; |
0040228C  |.  8D0440        LEA EAX,DWORD PTR DS:[EAX+EAX*2]         ; |
0040228F  |.  C1E0 03       SHL EAX,3                                ; |
00402292  |.  2BC1          SUB EAX,ECX                              ; |
00402294  |.  8D88 98C04600 LEA ECX,DWORD PTR DS:[EAX+46C098]        ; |
0040229A  |.  E8 B16E0000   CALL <EKD2Win.CheckIfSomeStatus>         ; \CheckIfSomeStatus
0040229F  |.  85C0          TEST EAX,EAX
004022A1  |.  0F84 04000000 JE EKD2Win.004022AB
004022A7  |.  C645 EC 02    MOV BYTE PTR SS:[EBP-14],2；如果有策略减伤buffer，给2次赌博机会

D、状态是否成功跟双方智力和随机数有关：
当Random%攻击方智力>=防御方智力/策略成功率基数时特效才能附加上
本次策略成功率基数=2
具体代码：

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
00402303  |.  33C9          |XOR ECX,ECX
00402305  |.  8AC8          |MOV CL,AL
00402307  |.  33DB          |XOR EBX,EBX
00402309  |.  8A5D 10       |MOV BL,BYTE PTR SS:[EBP+10]    ；策略成功率基数
0040230C  |.  8BC1          |MOV EAX,ECX
0040230E  |.  99            |CDQ
0040230F  |.  F7FB          |IDIV EBX
00402311  |.  8B4D E8       |MOV ECX,DWORD PTR SS:[EBP-18]
00402314  |.  3BC8          |CMP ECX,EAX                             ;  随机数%攻击方智力>=防御方智力/策略成功率基数

5、判断是否会全力一击
A、取得兵种攻击速度GSPD：
具体代码：

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
0042A3AE  |.  8A81 501F4500 MOV AL,BYTE PTR DS:[ECX+451F50]
0042A3B4  |.  8845 FC       MOV BYTE PTR SS:[EBP-4],AL
0042A3B7  |.  6A 02         PUSH 2                       ; /被减速
0042A3B9  |.  8B4D F8       MOV ECX,DWORD PTR SS:[EBP-8]             ; |
0042A3BC  |.  E8 8FEDFDFF   CALL <EKD2Win.CheckIfSomeStatus>      
0042A3C1  |.  85C0          TEST EAX,EAX
0042A3C3  |.  0F84 0B000000 JE EKD2Win.0042A3D4
0042A3C9  |.  33C0          XOR EAX,EAX
0042A3CB  |.  8A45 FC       MOV AL,BYTE PTR SS:[EBP-4]
0042A3CE  |.  C1F8 01       SAR EAX,1             ;速度/2

B、确认是否全力一击
当GSPD>Random%100是全力一击；
全力一击伤害A=Ax3/2=Ax150%
具体代码：

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
0042398C      6A 64         PUSH 64        ;100
0042398E  |.  E8 95390200   CALL <EKD2Win.Random%Arg1>               ; \Random%Arg1
00423993  |.  83C4 04       ADD ESP,4
00423996  |.  3BD8          CMP EBX,EAX
00423998  |.  0F86 16000000 JBE EKD2Win.004239B4                     ;  全力一击的概率
0042399E  |.  8B45 FC       MOV EAX,DWORD PTR SS:[EBP-4]
004239A1  |.  8D0440        LEA EAX,DWORD PTR DS:[EAX+EAX*2]         ;  致命一击伤害x3/2
004239A4  |.  99            CDQ
004239A5  |.  2BC2          SUB EAX,EDX
004239A7  |.  C1F8 01       SAR EAX,1
004239AA  |.  8945 FC       MOV DWORD PTR SS:[EBP-4],EAX
004239AD  |.  C745 F0 01000>MOV DWORD PTR SS:[EBP-10],1     ;  全力一击标示

6、等级相关的随机因素造成伤害变动：
A、前边计算出基础伤害Abase；
B、取得防御方等级Flevel，然后取得0~FLevel-1的随机值Frnd1；
C、取得攻击方等级Glevel，然后取得0~Glelev-1的随机值Grnd1；
D、比较Frnd1与Grnd1的大小；
D、1如果Frnd1<Grnd1，或者产生了全力一击；
那么伤害会随机增加（0~Glevel-1）%6之间的随机值Grnd2，结果为Abase=Abase+Grnd2
D、2如果Frnd1>=Grnd1，
那么伤害随机减少（0~Flevel-1）%6的随机值Frnd2，如果伤害为1，减少了2，那只能取0和1-2的最大值，即保证伤害不能为负数，结果为Abase=Max(Abase-Frnd2,0)

7、确认防御方是我军（15个部队）还是敌军；
如果是我军，那个会去确认游戏难度；
A、难度为初级的话，我军受伤害为Abase=Abasex80%；
B、难度为高级的话，我军受伤害为Abase=Abasex120%；
注：没有中级难度计算，那明显伤害为Abase=Abasex100%；
7部分的代码：

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
00423AC9  |.  8B0C88        MOV ECX,DWORD PTR DS:[EAX+ECX*4]
00423ACC  |.  E8 4F57FEFF   CALL <EKD2Win.CheckIfWoJun>              ;  防御方是我军还是敌军
00423AD1  |.  83F8 01       CMP EAX,1
00423AD4  |.  0F85 4A000000 JNZ EKD2Win.00423B24
00423ADA  |.  B9 D0A64600   MOV ECX,EKD2Win.0046A6D0
00423ADF  |.  E8 CC7FFEFF   CALL <EKD2Win.GetDifficultLevel>         ;  游戏难度00~02
00423AE4  |.  85C0          TEST EAX,EAX
00423AE6  |.  0F85 11000000 JNZ EKD2Win.00423AFD
00423AEC  |.  8B45 FC       MOV EAX,DWORD PTR SS:[EBP-4]             ;  难度为初级00的时候敌军对我伤害只有80%
00423AEF  |.  C1E0 03       SHL EAX,3
00423AF2  |.  B9 0A000000   MOV ECX,0A
00423AF7  |.  99            CDQ
00423AF8  |.  F7F9          IDIV ECX
00423AFA  |.  8945 FC       MOV DWORD PTR SS:[EBP-4],EAX
00423AFD  |>  B9 D0A64600   MOV ECX,EKD2Win.0046A6D0
00423B02  |.  E8 A97FFEFF   CALL <EKD2Win.GetDifficultLevel>
00423B07  |.  83F8 02       CMP EAX,2
00423B0A  |.  0F85 14000000 JNZ EKD2Win.00423B24
00423B10  |.  8B45 FC       MOV EAX,DWORD PTR SS:[EBP-4]             ;  游戏难度为高级的时候对我军伤害为120%
00423B13  |.  8D0440        LEA EAX,DWORD PTR DS:[EAX+EAX*2]         ;  没有计算中级难度，明显为100%，不加不减
00423B16  |.  C1E0 02       SHL EAX,2
00423B19  |.  B9 0A000000   MOV ECX,0A
00423B1E  |.  99            CDQ
00423B1F  |.  F7F9          IDIV ECX
00423B21  |.  8945 FC       MOV DWORD PTR SS:[EBP-4],EAX

8、取得防御方当前耐久力，如果最终的ABase>=耐久力的话，伤害Abase=耐久力；
如果伤害<耐久力的哈，Abase不变，这个是为了防止打出比当前耐久力还大的数；


9、关于连击
A、主动攻击的连击，还是主动攻击，反击的连击，还是反击，伤害按照上边的再次套用就行；
B、速度低于防御方的兵种，不会连击，至少跟防御方速度相等；
C、已经连击过的话，不能再连击；
具体代码：

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
0042497F  |.  8A5C01 36     MOV BL,BYTE PTR DS:[ECX+EAX+36]          ;  守方速度
00424983  |.  3BD3          CMP EDX,EBX                              ;  速度小于对方不能双击
00424985  |.  0F8C A2000000 JL EKD2Win.00424A2D
0042498B  |.  833D 18184500>CMP DWORD PTR DS:[451818],0 ;是否连击过，连击过则为1，下边有
00424992  |.  0F85 95000000 JNZ EKD2Win.00424A2D

D、连击算法要求：
攻击速度见上边5-A条
(攻击方速度-防御方速度+1)>Random%15
可见同等速度的话，有1/15的概率连击
武术家速度A，有好几个兵种速度只有2，连击概率：(10-2+1)/15=60%，有点夸张
具体代码：

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
004249BA  |.  2BDA          SUB EBX,EDX                              ;  二者速度差+1
004249BC  |.  43            INC EBX
004249BD      6A 0F         PUSH 0F
004249BF  |.  E8 64290200   CALL <EKD2Win.Random%Arg1>  
004249C4  |.  83C4 04       ADD ESP,4
004249C7  |.  3BD8          CMP EBX,EAX                              ;  （速度差+1）>15以内随机数，则连击
004249C9  |.  0F86 5E000000 JBE EKD2Win.00424A2D

E、连击判定成功的话，写入连击标识，下次不能连击
可以改成0，无限随机连击噢，不必担心不能结束，一是有概率，二是看下一条
具体代码：

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
004249CF      C705 18184500>MOV DWORD PTR DS:[451818],1              ;  写入标示1

F、即便连击判定成功，如果对方耐久力为0，则不会发生连击
具体代码：

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
004249EC  |.  85C0          TEST EAX,EAX
004249EE  |.  0F84 39000000 JE EKD2Win.00424A2D

附加：
10、由于没有设置兵种相克，我写了一个来满足一部分改造者的需求，基本思路是：
从0x42A66C开始：
00~27这40个兵种，需要一一给他设定一个大类，编号00~07，一共8大类，默认00
相克系数是0~255直接的任意值，我设定的结果是：
实际伤害=基本伤害x相克系数/100，
这样可以有75%，65%这种不是整十的系数存在，设定系数的时候也不用绕弯子了，方便一点
最大是255%，最小0，如果嫌系数范围不够，也可以把100这个数缩小一下。
当然实现方法很多，这里仅仅是一个例子
0x42A62C开始为相克系数表格结构：
每8个一组，分别是第00，第01……第07类克制其他大类的系数；默认00，需要自己设定；
很明显，自己克制自己系数为1，也就是100%，因为我这个例子是除以100的，所以对应设置应该为64H；如果你改了除数，记得系数也要同步改一下；
藤甲兵22H作为防御方时候单独计算；
具体代码见5楼：

上面那么大段的，我大概理解了一下。
======================================
就是说，命中率由攻击力和对方防御力共同决定。(假定已经把攻防地形修正过了)

命中率是拿防御力除以10来和攻击力作比较的。换句话说：

当攻击力和对方防御力差不多时，命中率是90%
当攻击力两倍于对方防御力时，命中率是95%
当攻击力只有对方防御力一半时，命中率是80%
当攻击力只有对方防御力的十分之一时，命中率=0%
======================================
如果命中，伤害数值的基本值，是由攻击力和对方防御力共同决定的。但是实际上防御力是除以二以后和攻击力去比较的。

如果攻击力还不到对方防御力的一半，那么随你怎么打吧，伤害都只有1。

大部分的情况，是用攻击力减去防御力的一半，得到最终的伤害值。

孔明传攻击性策略和攻击性道具伤害分析

相关求余随机数算法情况请看这个帖子：
http://www.xycq.net/forum/thread-213636-1-1.html
直接写结论吧：
策略攻击不存在致命一击和连击，也没有天气和除了兵种地形适应性以外的地形的额外加成。
策略只有火计和石计
初级：焦热，大焦热，落石，大落石
中级：火龙，大火龙，山崩，大山崩
高级：猛火，大猛火，山洪，大山洪

策略和道具基本威力系数跟策略范围是一个位置：

QUOTE:
原帖由 lewulezo 于 2010-5-28 13:53 发表
策略施放范围：0x4D2B0~0x4d2df
00 表示焦热范围
01 表示火龙范围
02 表示猛火范围
03 表示小补给范围

一、策略伤害
1、判断攻击是物理攻击还是策略攻击；
具体位置：

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
00423914  |.  8A48 12       MOV CL,BYTE PTR DS:[EAX+12]
00423917  |.  83F9 01       CMP ECX,1          ；;  物理攻击1策略伤害2道具伤害3

.....

004239C1  |.  83F9 02       CMP ECX,2   ；2，策略攻击
004239C4  |.  0F85 26000000 JNZ EKD2Win.004239F0

2、策略是否成功，策略倒是可以称为是否命中，可以计算一个命中率出来；
命中要求：
Random%攻击方智力>=防御方智力/5
注：如果没有命中，伤害为0，则直接跳到第8步执行；

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
00408827  |.  E8 E4080000   CALL <EKD2Win.GetZhiLi>                  ;  攻击方智力
0040882C  |.  33C9          XOR ECX,ECX
0040882E  |.  8AC8          MOV CL,AL
00408830  |.  51            PUSH ECX                                 ; /Arg1
00408831  |.  E8 F2EA0300   CALL <EKD2Win.Random%Arg1>               ; \Random%Arg1
00408836  |.  83C4 04       ADD ESP,4
00408839  |.  8BC8          MOV ECX,EAX
0040883B  |.  33C0          XOR EAX,EAX
0040883D  |.  8A45 F4       MOV AL,BYTE PTR SS:[EBP-C]               ;  防御方智力
00408840  |.  BB 05000000   MOV EBX,5
00408845  |.  99            CDQ
00408846  |.  F7FB          IDIV EBX
00408848  |.  3BC8          CMP ECX,EAX                              ;  攻击方智力随机数与防御方智力/5
0040884A  |.  0F83 0F000000 JNB EKD2Win.0040885F
00408850  |.  C745 FC 00000>MOV DWORD PTR SS:[EBP-4],0   ;不满足条件伤害为0，直接跳出本函数计算，显示策略失败。
00408857  |.  8B45 FC       MOV EAX,DWORD PTR SS:[EBP-4]
0040885A  |.  E9 A1000000   JMP EKD2Win.00408900

3、计算策略伤害：
伤害公式为分3个：
初级策略伤害=武将智力x2/5+策略基础伤害/2
中级策略伤害=武将智力x3/7+策略基础伤害/2
高级策略伤害=武将智力x4/5+策略基础伤害/2
——————策略基础伤害————————
             火计         落石
初级         50              75
中级         100            125   
高级         200            250

代码具体见：

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
http://www.xycq.net/forum/viewth ... page%3D1#pid2992611

4、buffer、地形、兵种伤害修正
A、有减伤buffer的话伤害减半

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
004086BB  |.  6A 08         PUSH 8                                                  ; /策略伤害减状态
004086BD  |.  8B4D F0       MOV ECX,DWORD PTR SS:[EBP-10]                        
004086C0  |.  E8 8B0A0000   CALL <EKD2Win.CheckIfSomeStatus>                        
004086C5  |.  85C0          TEST EAX,EAX
004086C7  |.  0F84 04000000 JE EKD2Win.004086D1
004086CD  |.  C16D 10 01    SHR DWORD PTR SS:[EBP+10],1    ;除以2

B、防御方所在地形修正
a、防御方地形适应性DX<10
伤害=伤害x(10-DX)/10+伤害
【因为是整数除法，没有化简如果化简合并的话伤害结果会变化,下同】
b、防御方地形适应性DX>10
伤害=伤害-伤害x(DX-10)/10


C、兵种修正：
a、如果是藤甲兵，并且是火计伤害
伤害=(策略威力基数/3+2)x伤害
火计和石计的策略威力基数从低级到高级都是00，01，02
b、如果是南蛮兵和南蛮骑兵
伤害=伤害x3/2
c、如果是军师、大军师、名军师、幻术师
伤害=伤害x2/3

B和C部分具体代码：

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
http://www.xycq.net/forum/viewth ... page%3D1#pid2992650

5、防御方智力修正：
伤害=伤害-防御方智力/2
具体代码：

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
00408894  |.  8A45 F4       MOV AL,BYTE PTR SS:[EBP-C]
00408897  |.  C1F8 01       SAR EAX,1
0040889A  |.  50            PUSH EAX                                                ; /Arg2
0040889B  |.  8B45 FC       MOV EAX,DWORD PTR SS:[EBP-4]                            ; |
0040889E  |.  50            PUSH EAX                                                ; |Arg1
0040889F  |.  E8 27EA0300   CALL 004472CB                        ; \伤害-防御方智力/2
004088A4  |.  83C4 08       ADD ESP,8

6、攻击方兵种修正：
军师、大军师、名军师、运粮队、物资队、军乐队的伤害会另外算上武器伤害
如果目前为止，伤害为0，则跳过第7条进入第8条判断


7、下边就跟物理攻击一样了，但没有全力一击和连击就是了；
以下为复制：
等级相关的随机因素造成伤害变动：
A、前边计算出基础伤害Abase；
B、取得防御方等级Flevel，然后取得0~FLevel-1的随机值Frnd1；
C、取得攻击方等级Glevel，然后取得0~Glelev-1的随机值Grnd1；
D、比较Frnd1与Grnd1的大小；
D、1如果Frnd1<Grnd1，或者产生了全力一击；
那么伤害会随机增加（0~Glevel-1）%6之间的随机值Grnd2，结果为Abase=Abase+Grnd2
D、2如果Frnd1>=Grnd1，
那么伤害随机减少（0~Flevel-1）%6的随机值Frnd2，如果伤害为1，减少了2，那只能取0和1-2的最大值，即保证伤害不能为负数，结果为Abase=Max(Abase-Frnd2,0)

8、确认防御方是我军（15个部队）还是敌军；
如果是我军，那个会去确认游戏难度；
难度为初级的话，我军受伤害为Abase=Abasex80%；
难度为高级的话，我军受伤害为Abase=Abasex120%；
注：没有中级难度计算，那明显伤害为Abase=Abasex100%；
8部分的代码：

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
00423AC9  |.  8B0C88        MOV ECX,DWORD PTR DS:[EAX+ECX*4]
00423ACC  |.  E8 4F57FEFF   CALL <EKD2Win.CheckIfWoJun>              ;  防御方是我军还是敌军
00423AD1  |.  83F8 01       CMP EAX,1
00423AD4  |.  0F85 4A000000 JNZ EKD2Win.00423B24
00423ADA  |.  B9 D0A64600   MOV ECX,EKD2Win.0046A6D0
00423ADF  |.  E8 CC7FFEFF   CALL <EKD2Win.GetDifficultLevel>         ;  游戏难度00~02
00423AE4  |.  85C0          TEST EAX,EAX
00423AE6  |.  0F85 11000000 JNZ EKD2Win.00423AFD
00423AEC  |.  8B45 FC       MOV EAX,DWORD PTR SS:[EBP-4]             ;  难度为初级00的时候敌军对我伤害只有80%
00423AEF  |.  C1E0 03       SHL EAX,3
00423AF2  |.  B9 0A000000   MOV ECX,0A
00423AF7  |.  99            CDQ
00423AF8  |.  F7F9          IDIV ECX
00423AFA  |.  8945 FC       MOV DWORD PTR SS:[EBP-4],EAX
00423AFD  |>  B9 D0A64600   MOV ECX,EKD2Win.0046A6D0
00423B02  |.  E8 A97FFEFF   CALL <EKD2Win.GetDifficultLevel>
00423B07  |.  83F8 02       CMP EAX,2
00423B0A  |.  0F85 14000000 JNZ EKD2Win.00423B24
00423B10  |.  8B45 FC       MOV EAX,DWORD PTR SS:[EBP-4]             ;  游戏难度为高级的时候对我军伤害为120%
00423B13  |.  8D0440        LEA EAX,DWORD PTR DS:[EAX+EAX*2]         ;  没有计算中级难度，明显为100%，不加不减
00423B16  |.  C1E0 02       SHL EAX,2
00423B19  |.  B9 0A000000   MOV ECX,0A
00423B1E  |.  99            CDQ
00423B1F  |.  F7F9          IDIV ECX
00423B21  |.  8945 FC       MOV DWORD PTR SS:[EBP-4],EAX

9、取得防御方当前耐久力，如果最终的ABase>=耐久力的话，伤害Abase=耐久力；
如果伤害<耐久力的哈，Abase不变，这个是为了防止打出比当前耐久力还大的数；


二、道具伤害，其实就是策略伤害的翻版，表现为伤害比较固定

1、基本伤害：初级：50+0~15的随机值
中级75+0~25的随机值
高级：150+0~50的随机值
跟兵种、等级、智力完全无关


代码：

QUOTE:
原帖由 ctermiii 于 2010-7-26 22:44 发表
0040897C   > /6A 10         PUSH 10                                
0040897E   . |E8 A5E90300   CALL <EKD2Win.Random%Arg1>         
00408983   . |83C4 04       ADD ESP,4
00408986   . |83C0 32       ADD EAX,32
00408989   . |8945 FC       MOV DWORD PTR SS:[EBP-4],EAX
0040898C   . |E9 54000000   JMP EKD2Win.004089E5
00408991   > |6A 1A         PUSH 1A                           
00408993   . |E8 90E90300   CALL <EKD2Win.Random%Arg1>         
00408998   . |83C4 04       ADD ESP,4
0040899B   . |83C0 4B       ADD EAX,4B
0040899E   . |8945 FC       MOV DWORD PTR SS:[EBP-4],EAX
004089A1   . |E9 3F000000   JMP EKD2Win.004089E5
004089A6   > |6A 33         PUSH 33                              
004089A8   . |E8 7BE90300   CALL <EKD2Win.Random%Arg1>  
004089AD   . |83C4 04       ADD ESP,4
004089B0   . |05 96000000   ADD EAX,96

2、兵种加成，跟上边策略类伤害的兵种与地形修正一样：

A、防御方所在地形修正
a、防御方地形适应性DX<10
伤害=伤害x(10-DX)/10+伤害
【因为是整数除法，没有化简如果化简合并的话伤害结果会变化,下同】
b、防御方地形适应性DX>10
伤害=伤害-伤害x(DX-10)/10


B、兵种修正：
a、如果是藤甲兵，并且是火计伤害
伤害=(策略威力基数/3+2)x伤害
火计和石计的策略威力基数从低级到高级都是00，01，02
b、如果是南蛮兵和南蛮骑兵
伤害=伤害x3/2
c、如果是军师、大军师、名军师、幻术师
伤害=伤害x2/3
3、道具一定可以造成伤害，等级因素与策略、物理攻击类一致，见上边第7条开始往下，不再重复。

ctermiii 的《三国孔明传物理伤害分析》代码解读

写在前面：

本帖对 ctermiii 的《三国孔明传物理伤害分析》进行代码解读，原帖地址：

http://www.xycq.net/forum/thread-213636-1-1.html

《三国孔明传物理伤害分析》的每次更新，本帖都将同步更新。

一、物理攻击

    注：红字部分表示这一步运算有可能或者一定会使结果变为零。

    计算一个0~(攻方攻击力*攻方所在地形因素/10)-1的随机数，
    如果该随机数<防御方防御力*防御方地形因素/10/10，并且防御方没有混乱，那么物理攻击伤害=0；
    否则：

        1、如果(防御力*地形因素/10+1)/2>=攻击方攻击力*攻击方所在地形因素/10，那么

            物理攻击伤害=1


            否则，物理攻击伤害=攻击力*地形因素/10-防御力*地形因素/10/2

        2、判断防御方兵种，如果

            （1）防御方为战车系，那么

                物理攻击伤害=3*物理攻击伤害/4


            （2）防御方为运粮、物资或军乐队，那么

                物理攻击伤害=3*物理攻击伤害/2


            （3）防御方为南蛮兵或南蛮骑兵，那么

                物理攻击伤害=物理攻击伤害/2


            （4）防御方为藤甲兵，那么

                物理攻击伤害=1

        3、如果是间接攻击[1]，那么

            物理攻击伤害=物理攻击伤害/2

        4、如果攻击方为象兵直接攻击[2]且防御方没混乱，或者攻击方为蛇兵直接攻击且防御方没中毒[3]，那么：计算一个0~攻击方智力-1的随机数，如果该随机数>=防御方智力/2

            （如果防御方带有“对策”效果，那么再算一次随机数并比较，但仅再算一次，第二次就无视“对策”效果了），那么：
            （1）如果攻击方是象兵，则防御方混乱
            （2）如果攻击方是蛇兵，则防御方中毒

        5、如果物理攻击伤害>0，那么：

            （1）计算一个0~99的随机数，如果该随机数<攻击方的攻击速度，那么发生全力一击：

                物理攻击伤害=3*物理攻击伤害/2


            （2）计算一个0~攻击方等级-1的随机数A与一个0~防御方等级-1的随机数D，如果随机数A>随机数D，或者发生了全力一击，那么

                计算一个0~攻击方等级-1的随机数A’，
                物理攻击伤害=物理攻击伤害+(随机数A’ mod 6)。[4]否则
                a)计算一个0~防御方等级-1的随机数D’，

                    物理攻击伤害=物理攻击伤害-(随机数D’ mod 6)。


                b)如果物理攻击伤害<0，那么

                    物理攻击伤害=0


            （3）如果防御方是我军，那么：

                a)如果是初级难度，那么

                    物理攻击伤害=8*物理攻击伤害/10


                b)如果是高级难度，那么

                    物理攻击伤害=12*物理攻击伤害/10

            （4）如果物理攻击伤害>防御方剩余耐久力，那么

                物理攻击伤害=防御方剩余耐久力

        6、执行攻击动作：

            防御方剩余耐久力=防御方剩余耐久力-物理攻击伤害


        7、计算一个0~14的随机数，如果该随机数<攻击方攻击速度-防御方攻击速度+1，且防御方剩余耐久力>0，那么发生连击，返回第1步再算一次（但仅再算一次）。


注释：
[1]间接攻击指的是反击，或者炮车、虎兵、蛇兵、象兵的非第一人攻击。
[2]直接攻击，就是对攻击点的第一人攻击，且非反击。
[3]中毒指的是耐久力每回合减少10%的状态
[4]mod是求余运算符号，A mod B就是正整数A除以正整数B得到的余数C，0<=C<B。

《三国志孔明传》剧本挑刺专帖

1、第2关-新野之战，战前选择“在城内迎敌”，战后实际所得为650金，可是却写着“得到了黄金９００！”。
　　将战后所得改成“得到了黄金６５０！”

修改 SNR0M.e2

简体复刻版 0x82D1
B9 A3 B0 A3 --> B6 A3 B5 A3

繁體版 0x89A1
B8 A2 AF A2 --> B5 A2 B4 A2

2、第9关-汉水战役，左边宝物库实际为1000金，却写着“得到了黄金２０００！”。
　　将宝物库所得改成将战后所得改成“得到了黄金１０００！”

修改 SNR1M.e2

简体复刻版 0xC109
B2-->B1

繁體版 0xC8C5
B1-->B0

诸位发现剧本内容与实际不符的，欢迎提出。

附件是以上两处错误的修正补丁，解压到游戏目录即可。

“玉溪峰” 全部写成 “五溪峰”

简体复刻版：

分别打开 SNR2M.e2 与 EKD2W95.exe（需要先脱壳，脱壳后的程序见http://www.xycq.net/forum/thread-198087-1-1.html  的3楼附件）

搜索所有的 CE E5 CF AA B7 E5 全部替换成 D3 F1 CF AA B7 E5

繁體版：

分别打开 SNR2M.e2 與 EKD2.exe

搜索所有的 A4 AD B7 CB AE 70 全部替換成 A5 C9 B7 CB AE 70

“费祎”没有简化，全写成“费禕”，仅简体版才有

分别打开BAKDATA.e2 与 SNR4M.e2

搜索
B7 D1 B6 42

全部替换成
B7 D1 B5 74

繁体版和简体中文光盘版的孔明都有5个头像：幼年，第一章，第二章，第三章，第四章和终章

但是复刻版只有3个头像：幼年，第一章，第四章和终章；其中第二章、第三章都使用第一章的头像。
但用RPGViewer确实能找到孔明的5个头像，不知道怎么改回去。

还有复刻版我就没见到孔明减红心，连不斩马谡减半颗红心都没有。

